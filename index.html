<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kicks - Boutique</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://www.google.com/recaptcha/api.js?hl=fr" async defer></script>
<script src="https://www.paypal.com/sdk/js?client-id=AXd7iZon2xRzhIauBjGdjwxQk237evP3BTtNfqIKpEaYDTOk9S733o-_GcPQIqhZ7bCalMG-M_PNaRHG&currency=EUR"></script>
<style>
  body { background: #f7f7f7; color: #111; }
  .dark-section { background-color: #1a1a1a; color: #f0f0f0; }
  .card { background-color: #fff; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .btn { transition: all 0.3s; }
  .btn:hover { transform: scale(1.05); }
</style>
</head>
<body class="font-sans">

<header class="p-6 flex items-center justify-between dark-section">
  <div id="logo-zone" class="text-2xl font-bold">Kicks</div>
  <a href="https://gdt.kixx.fr" target="_blank" class="text-blue-400 hover:underline">Guides des tailles</a>
</header>

<main class="p-6">
  <!-- CATALOGUE -->
  <section id="catalogue" class="grid md:grid-cols-3 sm:grid-cols-2 gap-6"></section>

  <!-- PANIER -->
  <section id="panier" class="mt-10 p-6 card">
    <h2 class="text-xl font-bold mb-4">Votre panier</h2>
    <div id="panier-items"></div>

    <div class="mt-4 flex justify-between items-center">
      <div>
        <label for="livraison">Mode de livraison :</label>
        <select id="livraison" class="border rounded p-2">
          <option value="standard" data-price="5">Standard - 5 €</option>
          <option value="express" data-price="10">Express - 10 €</option>
        </select>
      </div>
      <div class="text-right">
        <p>Total : <span id="total-panier">0.00 €</span></p>
      </div>
    </div>

    <div class="mt-6 flex gap-4">
      <div id="paypal-button-container"></div>
      <button id="payer-virement" class="btn bg-gray-800 text-white px-4 py-2 rounded">Payer par virement</button>
    </div>

    <div id="zone-virement" class="hidden mt-6 bg-gray-100 p-4 rounded">
      <h3 class="font-bold mb-2">Coordonnées bancaires (RIB)</h3>
      <p><strong>Banque :</strong> SumUp Limited</p>
      <p><strong>IBAN :</strong> IE85SUMU99036512267268</p>
      <p><strong>Titulaire :</strong> R.Laskari / Kicks</p>
    </div>

    <!-- FORMULAIRE DE COMMANDE -->
    <div id="order-form-container" class="mt-6" style="display:none;">
      <h3 class="font-bold text-lg mb-4">Validez votre commande</h3>
      <form id="order-form" class="space-y-2">
        <input type="text" name="firstName" placeholder="Prénom" required class="border rounded p-2 w-full">
        <input type="text" name="lastName" placeholder="Nom" required class="border rounded p-2 w-full">
        <input type="tel" name="phone" placeholder="Téléphone" required class="border rounded p-2 w-full">
        <input type="email" name="email" placeholder="Email" required class="border rounded p-2 w-full">
        <input type="text" name="address" placeholder="Adresse" required class="border rounded p-2 w-full">
        <input type="text" name="postalCode" placeholder="Code postal" required class="border rounded p-2 w-full">
        <input type="text" name="city" placeholder="Commune" required class="border rounded p-2 w-full">

        <div class="mt-2">
          <label for="payment">Mode de paiement :</label>
          <select name="payment" id="payment" required class="border rounded p-2 w-full">
            <option value="">--Choisissez--</option>
            <option value="paypal">PayPal</option>
            <option value="virement">Virement bancaire</option>
          </select>
        </div>

        <div class="g-recaptcha" data-sitekey="VOTRE_CLÉ_PUBLIQUE"></div>

        <button type="submit" class="btn bg-green-600 text-white px-4 py-2 rounded mt-2">Valider ma commande</button>
      </form>
    </div>

  </section>
</main>

<footer class="text-center mt-10 p-4 dark-section">
  <a href="https://shop.kixx.fr/page/conditions-generales" target="_blank" class="text-blue-400 hover:underline">Conditions générales</a>
  <div class="mt-2 text-sm text-gray-400">© 2025 Kicks</div>
</footer>

<div id="popup-remerciement" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center">
  <div class="bg-white text-center p-8 rounded-xl">
    <h2 class="text-2xl font-bold mb-4">Merci pour votre commande !</h2>
    <p>Fermeture automatique dans <span id="compteur">10</span> secondes...</p>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx1fmkYMGBmIdsTUo6mfMi8mD4yvLrbk9OWNJK2jlmYIEsXIliXfk8G14sPssWcRja2/exec";
let panier = [];
let livraisonPrix = 5;

// --- Charger catalogue depuis Apps Script ---
async function chargerCatalogue() {
  const res = await fetch(`${SCRIPT_URL}?action=getProduits`);
  const data = await res.json();
  if(!data.success) return;
  const container = document.getElementById('catalogue');
  container.innerHTML = '';
  data.products.forEach(prod=>{
    const div = document.createElement('div');
    div.className = 'card p-4';
    div.innerHTML = `
      <img src="${prod.imageUrl}" alt="${prod.masterNameBase}" class="rounded mb-2 w-full h-48 object-cover">
      <h3 class="font-bold text-lg mb-1">${prod.masterNameBase}</h3>
      <p class="text-sm mb-2">${prod.description}</p>
      <select id="size-${prod.modelBaseId}" class="border rounded p-1 mb-2 w-full">
        ${prod.sizes.map(s=>`<option value="${s.fullId}" data-price="${s.price}" data-stock="${s.stock}">${s.size} - ${s.price.toFixed(2)} €</option>`).join('')}
      </select>
      <div class="flex justify-between items-center">
        <button class="btn bg-gray-200 px-2 rounded" onclick="ajouterAuPanier('${prod.modelBaseId}')">+ Ajouter</button>
        <span id="stock-${prod.modelBaseId}" class="text-sm text-gray-500">Stock : ${prod.sizes[0].stock}</span>
      </div>`;
    container.appendChild(div);
  });
}

// --- Ajouter produit au panier ---
function ajouterAuPanier(modelBaseId){
  const select = document.getElementById(`size-${modelBaseId}`);
  const option = select.options[select.selectedIndex];
  const id = option.value;
  const price = parseFloat(option.dataset.price);
  const stock = parseInt(option.dataset.stock);
  if(stock<=0) return alert('Stock épuisé');
  const existing = panier.find(p=>p.id===id);
  if(existing) existing.quantity++;
  else panier.push({id, modelBaseId, price, quantity:1});
  majPanier();
}

// --- Mettre à jour le panier ---
function majPanier(){
  const container = document.getElementById('panier-items');
  container.innerHTML = '';
  let total = 0;
  panier.forEach(item=>{
    total += item.price*item.quantity;
    const div = document.createElement('div');
    div.className = 'flex justify-between items-center border-b py-2';
    div.innerHTML = `
      <span>${item.id}</span>
      <div>
        <button onclick="changerQte('${item.id}',-1)" class="px-2">-</button>
        ${item.quantity}
        <button onclick="changerQte('${item.id}',1)" class="px-2">+</button>
      </div>
      <span>${(item.price*item.quantity).toFixed(2)} €</span>`;
    container.appendChild(div);
  });
  const totalAvecLivraison = total + livraisonPrix;
  document.getElementById('total-panier').textContent = totalAvecLivraison.toFixed(2)+' €';

  document.getElementById('order-form-container').style.display = panier.length>0 ? 'block' : 'none';
}

// --- Changer quantité ---
function changerQte(id,delta){
  const item = panier.find(p=>p.id===id);
  if(!item) return;
  item.quantity += delta;
  if(item.quantity<=0) panier.splice(panier.indexOf(item),1);
  majPanier();
}

// --- Mise à jour prix livraison ---
document.getElementById('livraison').addEventListener('change', function(){
  const option = this.options[this.selectedIndex];
  livraisonPrix = parseFloat(option.dataset.price);
  majPanier();
});

// --- RIB pour virement ---
document.getElementById('payer-virement').addEventListener('click',()=>{
  document.getElementById('zone-virement').classList.toggle('hidden');
});

// --- Popup confirmation ---
function afficherPopup(){
  const popup=document.getElementById('popup-remerciement');
  popup.classList.remove('hidden');
  let count=10;
  const interval=setInterval(()=>{
    count--;
    document.getElementById('compteur').textContent = count;
    if(count<=0){clearInterval(interval);popup.classList.add('hidden');}
  },1000);
}

// --- Soumission du formulaire ---
document.getElementById('order-form').addEventListener('submit', function(e){
  e.preventDefault();
  const form = e.target;
  const data = {
    action:'createOrder',
    cart: panier,
    firstName: form.firstName.value,
    lastName: form.lastName.value,
    phone: form.phone.value,
    email: form.email.value,
    address: form.address.value,
    postalCode: form.postalCode.value,
    city: form.city.value,
    delivery: document.getElementById('livraison').value,
    deliveryPrice: livraisonPrix,
    payment: form.payment.value,
    recaptcha: grecaptcha.getResponse()
  };
  fetch(SCRIPT_URL, {method:'POST', mode:'no-cors', body: JSON.stringify(data)})
    .then(()=>{
      afficherPopup();
      panier = [];
      majPanier();
      form.reset();
      grecaptcha.reset();
    })
    .catch(err=>console.error(err));
});

// --- Bouton PayPal ---
paypal.Buttons({
  createOrder: (data, actions) => {
    const total = panier.reduce((sum,p)=>sum+p.price*p.quantity,0)+livraisonPrix;
    return actions.order.create({
      purchase_units: [{ amount: { value: total.toFixed(2), currency_code:'EUR' } }]
    });
  },
  onApprove: (data, actions) => {
    return actions.order.capture().then(details => {
      alert('Paiement PayPal effectué avec succès !');
      panier = [];
      majPanier();
    });
  }
}).render('#paypal-button-container');

window.onload = chargerCatalogue;
</script>
</body>
</html>
