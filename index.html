<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kicks - Boutique</title>

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://www.google.com/recaptcha/api.js?hl=fr" async defer></script>
<script src="https://www.paypal.com/sdk/js?client-id=AXd7iZon2xRzhIauBjGdjwxQk237evP3BTtNfqIKpEaYDTOk9S733o-_GcPQIqhZ7bCalMG-M_PNaRHG&currency=EUR" data-sdk-integration-source="button-factory"></script>

<script type="text/javascript" src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>

<style>
  :root{
    --orange:#FFA133;
    --anthracite:#1a1a1a;
    --white:#ffffff;
    --paypal:#003087;
    --whatsapp: #25D366;
    --bg:#f8f8f8;
  }
  html,body{ height:100%; margin:0; padding:0; background:var(--bg); font-family:Inter,system-ui,Arial,Helvetica,sans-serif; color:#111; -webkit-font-smoothing:antialiased; }
  .cart-count{ background:var(--orange); color:var(--white); }
  .bg-primary{ background-color: var(--orange); }
  .text-primary{ color: var(--orange); }
  .btn-primary{ background-color: var(--orange); color: var(--white); transition: background-color 0.2s; }
  .btn-primary:hover{ background-color: #e68d2a; }
  .bg-anthracite{ background-color: var(--anthracite); color: var(--white); }
  .whatsapp-btn{ background-color: var(--whatsapp); color: var(--white); }
  .whatsapp-btn:hover{ background-color: #1fbf52; }
  .modal-overlay { background-color: rgba(0, 0, 0, 0.7); }
  .header-spacer { height: 60px; }
  @media (max-width: 768px) {
    .header-spacer { height: 120px; } /* Ajuster la hauteur pour mobile si le header se déplie */
  }
  .cart-container {
      transition: transform 0.3s ease-in-out;
  }
  .cart-open {
      transform: translateX(0);
  }
  .cart-closed {
      transform: translateX(100%);
  }
</style>
</head>

<body class="min-h-screen flex flex-col">

<header id="header" class="fixed top-0 left-0 right-0 z-50 bg-anthracite shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center flex-wrap md:flex-nowrap">
        <a href="#" class="text-2xl font-bold text-primary">KICKS</a>
        <nav class="flex space-x-4 mt-2 md:mt-0">
            <a href="#produits" class="text-white hover:text-primary transition">Produits</a>
            <a href="#contact" class="text-white hover:text-primary transition">Contact</a>
        </nav>
        <div class="flex items-center space-x-4 mt-2 md:mt-0">
            <button id="cart-button" class="relative p-2 rounded-full hover:bg-gray-800 transition">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span id="cart-count" class="cart-count absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none transform translate-x-1/2 -translate-y-1/2 rounded-full">0</span>
            </button>
        </div>
    </div>
</header>
<div class="header-spacer"></div>

<main class="flex-grow p-4 md:p-8">

<section id="produits" class="max-w-7xl mx-auto">
    <h2 class="text-3xl font-bold mb-6 text-anthracite border-b border-orange pb-2">Nos Produits</h2>
    
    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        </div>

    <p id="loading-message" class="text-center text-gray-500 mt-10">Chargement des produits...</p>

</section>

<div id="img-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden" onclick="if(event.target.id === 'img-modal') this.style.display='none'">
    <div class="relative max-w-4xl max-h-full mx-4">
        <button id="close-img-modal" class="absolute top-2 right-2 text-white text-3xl font-bold z-50 bg-black bg-opacity-50 rounded-full px-3 py-1">&times;</button>
        <div class="flex items-center justify-between p-4">
            <button id="prev-img" class="text-white text-4xl p-2 bg-black bg-opacity-50 rounded-full">&lt;</button>
            <img id="modal-image" class="max-w-full max-h-[80vh] object-contain" src="" alt="Aperçu du produit">
            <button id="next-img" class="text-white text-4xl p-2 bg-black bg-opacity-50 rounded-full">&gt;</button>
        </div>
    </div>
</div>

</main>
<aside id="cart-drawer" class="cart-closed fixed right-0 top-0 bottom-0 w-full md:w-96 bg-white shadow-2xl z-40 p-6 overflow-y-auto">
    <div class="flex justify-between items-center border-b pb-4 mb-4">
        <h3 class="text-2xl font-bold text-anthracite">Votre Panier</h3>
        <button id="close-cart-button" class="text-gray-500 hover:text-anthracite text-3xl font-bold">&times;</button>
    </div>

    <div id="cart-items" class="space-y-4 min-h-[100px]">
        <p id="empty-cart-message" class="text-gray-500 text-center">Votre panier est vide.</p>
    </div>

    <div class="mt-6 pt-4 border-t">
        <div class="flex justify-between font-bold text-lg mb-2">
            <span>Sous-Total:</span>
            <span id="cart-subtotal">0,00 €</span>
        </div>
        
        <div id="shipping-display" class="hidden flex justify-between font-bold text-lg mb-2 text-green-600">
            <span>Livraison (<span id="shipping-method-name">...</span>):</span>
            <span id="shipping-cost">0,00 €</span>
        </div>

        <div class="flex justify-between font-extrabold text-xl text-primary border-t pt-2 mt-2">
            <span>Total:</span>
            <span id="cart-total">0,00 €</span>
        </div>
    </div>

    <button id="btn-clear-cart-default" class="w-full mt-4 text-sm text-red-500 hover:text-red-700 transition">Vider le panier</button>

    <button id="checkout-button" class="btn-primary w-full py-3 mt-4 rounded-lg font-semibold hover:bg-opacity-90 transition">
        Passer la commande
    </button>
</aside>
<div id="checkout-overlay" class="modal-overlay fixed inset-0 z-40 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 class="text-2xl font-bold text-anthracite">Informations de livraison et Paiement</h3>
            <button id="close-checkout-button" class="text-gray-500 hover:text-anthracite text-3xl font-bold">&times;</button>
        </div>

        <form id="checkout-form" class="space-y-4">
            <div class="border p-4 rounded-lg">
                <h4 class="font-semibold mb-3 border-b pb-2">Vos informations</h4>
                <input type="text" id="prenom" placeholder="Prénom" class="w-full p-2 border rounded-md" required>
                <input type="text" id="nom" placeholder="Nom" class="w-full p-2 border rounded-md mt-2" required>
                <input type="tel" id="telephone" placeholder="Téléphone (ex: 0690xxxxxx)" class="w-full p-2 border rounded-md mt-2" required>
                <input type="email" id="email" placeholder="Email" class="w-full p-2 border rounded-md mt-2" required>
            </div>

            <div class="border p-4 rounded-lg">
                <h4 class="font-semibold mb-3 border-b pb-2">Livraison</h4>
                <div class="flex space-x-2 mb-2">
                    <input type="text" id="commune" placeholder="Ville/Commune" class="w-1/2 p-2 border rounded-md" required>
                    <input type="text" id="cp" placeholder="Code Postal" class="w-1/2 p-2 border rounded-md" required>
                </div>
                <input type="text" id="adresse" placeholder="Adresse complète (Rue, Numéro, Bâtiment)" class="w-full p-2 border rounded-md" required>
                <input type="text" id="adresse-complement" placeholder="Complément d'adresse (Optionnel)" class="w-full p-2 border rounded-md mt-2">
                <select id="shipping-zone" class="w-full p-2 border rounded-md mt-2" required>
                    <option value="" disabled selected>Sélectionnez votre zone de livraison</option>
                    <option value="Guadeloupe">Guadeloupe</option>
                    <option value="Antilles">Martinique, Guyane, St-Barth, St-Martin</option>
                    <option value="FranceMetropolitaine">France Métropolitaine, Corse, Monaco, Andorre</option>
                </select>
                
                <div id="shipping-options-container" class="mt-4 p-3 bg-gray-50 rounded-md hidden">
                    <p class="font-medium mb-2">Modes de livraison disponibles :</p>
                    <div id="shipping-options" class="space-y-2">
                        </div>
                </div>
            </div>

            <div class="border p-4 rounded-lg">
                <h4 class="font-semibold mb-3 border-b pb-2">Paiement</h4>
                <select id="payment-method" class="w-full p-2 border rounded-md" required onchange="handlePaymentMethodChange()">
                    <option value="sumup" selected>Carte Bancaire (SumUp - Recommandé)</option>
                    <option value="virement">Virement Bancaire (Rapide)</option>
                    <option value="paypal">PayPal</option>
                </select>
                
                <div id="payment-area" class="mt-4 space-y-3">
                    <div id="paypal-button-container" class="hidden"></div>
                    
                    <button type="button" id="sumup-btn" class="btn-primary w-full py-3 rounded-lg font-semibold hover:bg-opacity-90 transition">
                        Payer <span id="sumup-total">0,00 €</span> par Carte
                    </button>

                    <div id="virement-info" class="hidden border border-orange p-3 rounded-md">
                        <p class="font-bold text-primary">Information pour le Virement Bancaire :</p>
                        <p class="text-sm">Veuillez effectuer un virement du montant total à l'ordre de **E.I.RL Kicks**.</p>
                        <p class="text-sm">IBAN: **IE85SUMU99513337985429**</p>
                        <p class="text-xs mt-1">Votre commande sera validée après réception du virement. Votre ID de commande vous sera fourni à l'étape suivante.</p>
                        <button type="button" id="virement-button" class="mt-2 text-primary font-semibold text-sm">Masquer/Afficher les infos</button>
                    </div>
                </div>
            </div>

            <div class="g-recaptcha flex justify-center" data-sitekey="6LcBZwosAAAAAG8xMR5po1FuipWeEo-_mJlROYFN"></div>

            <button type="button" id="btn-submit-quick" class="btn-primary w-full py-3 rounded-lg font-semibold transition hidden">
                Confirmer la commande par Virement
            </button>
        </form>
    </div>
</div>

<footer id="contact" class="bg-anthracite mt-10">
    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-white">
            <div>
                <h3 class="text-xl font-bold text-primary mb-4">Newsletter Kicks</h3>
                <p class="text-sm mb-4">Recevez nos dernières offres et nouveautés directement dans votre boîte mail.</p>
                <form id="newsletter-form" class="flex">
                    <input type="email" id="newsletter-email" placeholder="Votre email" class="p-2 flex-grow rounded-l-md text-gray-800" required>
                    <button type="submit" class="bg-primary text-white p-2 rounded-r-md font-semibold hover:bg-opacity-80">S'inscrire</button>
                </form>
                <p id="newsletter-message" class="mt-2 text-sm italic"></p>
            </div>
            
            <div>
                <h3 class="text-xl font-bold text-primary mb-4">Contact & Info</h3>
                <ul class="space-y-2 text-sm">
                    <li><a href="mailto:contact@kicks.com" class="hover:text-primary transition">Email: contact@kicks.com</a></li>
                    <li>Téléphone: +590 690 XX XX XX</li>
                    <li><a href="#" class="hover:text-primary transition">FAQ et Retours</a></li>
                </ul>
                <a href="https://wa.me/590690xxxxxx" target="_blank" class="whatsapp-btn inline-flex items-center space-x-2 px-3 py-1 mt-4 rounded-full font-semibold">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.031 3.23c-5.183 0-9.407 4.225-9.407 9.407 0 1.936.582 3.79 1.62 5.372l-1.68 5.75c.101.033.203.066.307.066h.001l5.96-1.666c1.558.89 3.327 1.354 5.199 1.354 5.183 0 9.407-4.225 9.407-9.407 0-5.182-4.224-9.407-9.407-9.407zm0 1.688c4.265 0 7.72 3.456 7.72 7.72 0 4.265-3.455 7.72-7.72 7.72-1.637 0-3.181-.527-4.444-1.503l-1.127-.88-4.723 1.318 1.34-4.593-.91-1.16c-1.04-1.282-1.65-2.883-1.65-4.592 0-4.265 3.455-7.72 7.72-7.72zm-3.04 4.09l-.497 1.258c-.147.373-.047.804.246 1.05l1.624 1.332c.112.093.225.187.337.28l.896.71c.14.112.337.112.478 0l.966-.998c.112-.112.308-.112.42 0l1.246 1.247c.14.14.337.14.478 0l.497-.497c.14-.14.14-.337 0-.478l-1.247-1.247c-.112-.112-.308-.112-.42 0l-.966.998c-.14.14-.337.14-.478 0l-.896-.71c-.112-.093-.225-.187-.337-.28l-1.624-1.332c-.373-.308-.478-.85-.246-1.205l.497-1.258c.14-.373 0-.71-.308-.87l-1.33-.71c-.373-.17-.768-.07-.94.246l-.564.786z"/></svg>
                    <span>WhatsApp</span>
                </a>
            </div>

            <div>
                <h3 class="text-xl font-bold text-primary mb-4">Informations Légales</h3>
                <ul class="space-y-2 text-sm">
                    <li>SIRET: 990 351 702 00016</li>
                    <li><a href="#" class="hover:text-primary transition">Conditions Générales de Vente</a></li>
                    <li><a href="#" class="hover:text-primary transition">Politique de Confidentialité</a></li>
                </ul>
            </div>
        </div>
        <div class="mt-8 pt-4 border-t border-gray-700 text-center text-sm text-gray-400">
            &copy; 2025 Kicks. Tous droits réservés.
        </div>
    </div>
</footer>

<script>
// =========================================================================================
// PARTIE 4 : JAVASCRIPT - CONFIGURATION ET FONCTIONS UTILITAIRES
// =========================================================================================

// !!! ATTENTION : REMPLACER CETTE VALEUR PAR L'URL DE DÉPLOIEMENT DE VOTRE APPS SCRIPT !!!
const API_URL = 'https://script.google.com/macros/s/AKfycbxPWgXGaR1YUbznCT4fEr1coqDtmtyMVUdlKGlEEpBXo7JhDsJpiFbrFZkfPcl1of9U_w/exec'; // Ex: https://script.google.com/macros/s/AKfyc.../exec

let products = [];
let cart = JSON.parse(localStorage.getItem('kicks_cart') || '[]');
let totalCart = 0;
let shippingCost = 0;
let selectedShippingRate = null;

const formatPrice = (price) => {
    return price.toFixed(2).replace('.', ',') + ' €';
};

const getCartTotal = () => {
    let subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    totalCart = subtotal + shippingCost;
    return subtotal;
};

const updateCartDisplays = () => {
    const subtotal = getCartTotal();
    
    document.getElementById('cart-count').textContent = cart.length;
    document.getElementById('cart-subtotal').textContent = formatPrice(subtotal);
    
    document.getElementById('cart-total').textContent = formatPrice(totalCart);
    document.getElementById('sumup-total').textContent = formatPrice(totalCart);
    
    // Affichage des articles dans le panier
    const cartItemsEl = document.getElementById('cart-items');
    cartItemsEl.innerHTML = '';

    if (cart.length === 0) {
        document.getElementById('empty-cart-message').style.display = 'block';
        document.getElementById('checkout-button').disabled = true;
        document.getElementById('shipping-display').classList.add('hidden');
        shippingCost = 0; // Réinitialiser si le panier est vide
        selectedShippingRate = null;
        updateCartDisplays(); // Mise à jour pour s'assurer que le total est à 0
        return;
    } else {
        document.getElementById('empty-cart-message').style.display = 'none';
        document.getElementById('checkout-button').disabled = false;
    }

    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        cartItemsEl.innerHTML += `
            <div class="flex items-center space-x-4 border-b pb-3">
                <img src="${item.imageUrls[0]}" alt="${item.masterName}" class="w-16 h-16 object-cover rounded-md">
                <div class="flex-grow">
                    <p class="font-semibold">${item.masterName} - T. ${item.size}</p>
                    <p class="text-sm text-gray-500">${formatPrice(item.price)} x ${item.quantity}</p>
                    <p class="font-bold text-primary">${formatPrice(itemTotal)}</p>
                </div>
                <button onclick="removeFromCart('${item.id}', true)" class="text-red-500 hover:text-red-700 text-xl leading-none">&times;</button>
            </div>
        `;
    });

    // Sauvegarde du panier
    localStorage.setItem('kicks_cart', JSON.stringify(cart));
};

const findProduct = (id) => {
    return products.find(p => p.id === id);
};

const addToCart = (id, size) => {
    const fullId = `${id}_${size}`;
    const productData = findProduct(fullId);

    if (!productData) {
        return alert("Produit non trouvé.");
    }
    if (productData.stock <= 0) {
        return alert("Désolé, ce produit est en rupture de stock.");
    }

    const existingItem = cart.find(item => item.id === fullId);

    if (existingItem) {
        if (existingItem.quantity < productData.stock) {
            existingItem.quantity++;
        } else {
            return alert(`Stock maximum atteint pour cet article (${productData.stock}).`);
        }
    } else {
        cart.push({
            id: fullId,
            masterName: productData.masterName,
            size: productData.size,
            price: productData.price,
            imageUrls: productData.imageUrls,
            quantity: 1,
            stock: productData.stock // Pour vérification rapide
        });
    }

    updateCartDisplays();
    alert(`Ajouté au panier: ${productData.masterName} - T. ${productData.size}`);
    document.getElementById('cart-drawer').classList.remove('cart-closed');
    document.getElementById('cart-drawer').classList.add('cart-open');
};

const removeFromCart = (fullId, confirmRemoval = false) => {
    const itemIndex = cart.findIndex(item => item.id === fullId);
    if (itemIndex > -1) {
        if (confirmRemoval && !confirm('Voulez-vous vraiment retirer cet article ?')) {
            return;
        }
        cart.splice(itemIndex, 1);
        // Après suppression, les frais de port doivent être recalculés
        calculateAndDisplayShipping(document.getElementById('shipping-zone').value, true); 
        updateCartDisplays();
    }
};

const showConfirmationAndClear = (prenom) => {
    alert(`Merci ${prenom} ! Votre commande a été enregistrée. Un email de confirmation vous a été envoyé. Le panier a été vidé.`);
    cart = [];
    shippingCost = 0;
    selectedShippingRate = null;
    updateCartDisplays();
    document.getElementById('checkout-overlay').classList.add('hidden');
    document.getElementById('cart-drawer').classList.remove('cart-open');
    document.getElementById('cart-drawer').classList.add('cart-closed');
    // Réinitialiser le formulaire et le reCAPTCHA
    document.getElementById('checkout-form').reset();
    if (typeof grecaptcha !== 'undefined' && grecaptcha.reset) {
        grecaptcha.reset();
    }
};
// =========================================================================================
// PARTIE 5 : JAVASCRIPT - RENDU PRODUITS ET MODALS
// =========================================================================================

const renderProduct = (p) => {
    const availableSizes = products
        .filter(item => item.masterName === p.masterName)
        .sort((a, b) => parseInt(a.size) - parseInt(b.size))
        .map(item => ({
            size: item.size,
            stock: item.stock,
            fullId: item.id
        }))
        .filter(item => item.stock > 0); // On affiche seulement les tailles en stock

    if (availableSizes.length === 0) return ''; // Ne rien afficher si toutes les tailles sont en rupture

    const cardHtml = `
        <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col hover:shadow-xl transition duration-300">
            <div class="relative overflow-hidden cursor-pointer h-64" onclick="openImageModal('${p.masterName}')">
                <img src="${p.imageUrls[0]}" alt="${p.masterName}" class="w-full h-full object-cover transition duration-500 hover:scale-105">
                <span class="absolute top-2 right-2 bg-anthracite text-white text-xs font-semibold px-3 py-1 rounded-full">
                    ${formatPrice(p.price)}
                </span>
            </div>
            
            <div class="p-5 flex-grow">
                <h3 class="text-xl font-bold text-anthracite mb-1">${p.masterName}</h3>
                <p class="text-sm text-gray-500 mb-3">${p.category}</p>
                <div class="text-sm text-gray-700 h-10 overflow-hidden">${p.seoDescription.substring(0, 100)}...</div>
            </div>
            
            <div class="p-5 border-t">
                <p class="font-semibold mb-2 text-anthracite">Tailles disponibles:</p>
                <div class="flex flex-wrap gap-2 mb-4">
                    ${availableSizes.map(s => `
                        <button 
                            onclick="addToCart('${p.id.split('_')[0]}', '${s.size}')"
                            class="bg-gray-100 text-anthracite hover:bg-orange hover:text-white transition duration-200 text-sm font-medium py-1 px-3 rounded-full"
                        >
                            T. ${s.size}
                        </button>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    return cardHtml;
};

const renderProducts = (data) => {
    products = data;
    const listEl = document.getElementById('product-list');
    listEl.innerHTML = '';
    
    // Filtrer pour obtenir une seule entrée par MasterName pour l'affichage de la carte
    const uniqueProducts = [];
    const masterNames = new Set();

    data.forEach(p => {
        if (!masterNames.has(p.masterName)) {
            masterNames.add(p.masterName);
            uniqueProducts.push(p);
        }
    });

    if (uniqueProducts.length === 0) {
        document.getElementById('loading-message').textContent = 'Aucun produit trouvé ou stock épuisé.';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';

    uniqueProducts.forEach(p => {
        listEl.innerHTML += renderProduct(p);
    });
};

let currentModal = { imgIndex: 0, productMasterName: null, productData: null };

const openImageModal = (masterName) => {
    const productData = products.find(p => p.masterName === masterName);
    if (!productData || productData.imageUrls.length === 0) return;

    currentModal.imgIndex = 0;
    currentModal.productMasterName = masterName;
    currentModal.productData = productData;

    document.getElementById('modal-image').src = productData.imageUrls[0];
    document.getElementById('img-modal').style.display = 'flex';
};

const changeImage = (direction) => {
    const p = currentModal.productData;
    if (!p) return;

    let newIndex = currentModal.imgIndex + direction;

    if (newIndex < 0) {
        newIndex = p.imageUrls.length - 1;
    } else if (newIndex >= p.imageUrls.length) {
        newIndex = 0;
    }

    currentModal.imgIndex = newIndex;
    document.getElementById('modal-image').src = p.imageUrls[newIndex];
};
// =========================================================================================
// PARTIE 6 : JAVASCRIPT - RÉSEAU, PAIEMENT SUMUP ET FRAIS DE LIVRAISON (CORRIGÉ)
// =========================================================================================

// --- Fonctions de Requête ---
const fetchProducts = async () => {
    try {
        const response = await fetch(`${API_URL}?action=getProduits`);
        const data = await response.json();
        if (data.success && data.products) {
            renderProducts(data.products);
        } else {
            document.getElementById('loading-message').textContent = 'Erreur: ' + (data.error || 'Impossible de charger les produits.');
        }
    } catch (e) {
        document.getElementById('loading-message').textContent = 'Erreur réseau lors du chargement des produits.';
        console.error('Fetch products error:', e);
    }
};

const postCreateOrder = async (payload) => {
    if (API_URL === 'VOTRE_URL_APPS_SCRIPT_ICI') {
        throw new Error('API_URL non configurée.');
    }
    const response = await fetch(`${API_URL}?action=createOrder`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // Utiliser text/plain pour Apps Script
        body: JSON.stringify(payload)
    });
    return response.json();
};

const postNewsletterSignup = async (email) => {
    if (API_URL === 'VOTRE_URL_APPS_SCRIPT_ICI') {
        throw new Error('API_URL non configurée.');
    }
    const response = await fetch(`${API_URL}?action=addNewsletter`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ email: email })
    });
    return response.json();
};

// --- Logique de Paiement SumUp (CORRIGÉE) ---

/**
 * Gère l'initialisation du paiement SumUp
 */
const handleSumUpCheckout = async () => {
    if (cart.length === 0) return alert('Votre panier est vide.');
    
    // 1. Validation du formulaire et reCAPTCHA
    if (!document.getElementById('checkout-form').checkValidity()) {
        alert("Veuillez remplir tous les champs obligatoires du formulaire de livraison.");
        document.getElementById('checkout-form').reportValidity();
        return;
    }
    if (!selectedShippingRate) {
        alert("Veuillez sélectionner un mode de livraison.");
        return;
    }
    const token = grecaptcha.getResponse();
    if (!token) return alert('Veuillez compléter le reCAPTCHA.');

    // 2. Création du payload de commande (inclut le mode SumUp et les frais de port)
    const payload = buildCreateOrderPayload('sumup', selectedShippingRate.rateId);
    
    try {
        // 3. Appel à Apps Script pour créer un checkout SumUp
        const apiResponse = await fetch(`${API_URL}?action=createSumUpCheckout`, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
        });
        const data = await apiResponse.json();

        if (!data.success || !data.checkoutId) {
            alert('Erreur SumUp: ' + (data.error || 'Échec de la création du paiement.'));
            console.error('SumUp API Error:', data);
            return;
        }

        const { checkoutId, checkoutUrl } = data;

        // 4. Utilisation du SDK SumUp pour ouvrir le modal de paiement
        const checkout = new SumUp.checkout({
            checkoutId: checkoutId,
            checkoutUrl: checkoutUrl,
            onResponse: async (type, body) => {
                if (type === 'success') {
                    // La transaction SumUp est réussie. On doit confirmer la commande.
                    
                    // 5. Appel à Apps Script pour confirmer la commande
                    const confirmationPayload = {
                        ...payload,
                        checkoutId: checkoutId,
                        sumUpStatus: body.status, // 'PAID'
                    };

                    const confirmationData = await postCreateOrder(confirmationPayload);
                    
                    if (confirmationData.success) {
                        showConfirmationAndClear(payload.prenom);
                    } else {
                        alert('Paiement réussi mais erreur à la confirmation de commande. Contactez-nous avec l\'ID: ' + checkoutId);
                        console.error('Order Confirmation Error:', confirmationData);
                    }
                } else if (type === 'error' || body.status === 'FAILED') {
                    alert('Erreur de paiement SumUp : ' + (body.message || 'Transaction échouée.'));
                    console.error('SumUp Error:', body);
                } else if (type === 'close') {
                    // Utilisateur a fermé le modal
                    console.log('SumUp checkout closed.');
                }
            }
        });
        
        checkout.open();

    } catch (e) {
        console.error('SumUp/Network Error:', e);
        alert('Erreur réseau ou du serveur lors de la tentative de paiement.');
    }
}; // <--- CORRECTION: CETTE ACCCOLADE EST LA FERMETURE MANQUANTE DE handleSumUpCheckout (Ligne 760)

// --- Logique des Frais de Livraison ---

let shippingRates = {}; // Contient les tarifs par zone (Guadeloupe, Antilles, France...)

const fetchShippingRates = async () => {
    try {
        const response = await fetch(`${API_URL}?action=getShippingRates`);
        const data = await response.json();
        if (data.success && data.rates) {
            shippingRates = data.rates;
        } else {
            console.error('Erreur: Impossible de charger les tarifs de livraison.', data.error);
        }
    } catch (e) {
        console.error('Erreur réseau lors du chargement des tarifs de livraison:', e);
    }
};

const getApplicableRates = (zone) => {
    return shippingRates[zone] || [];
};

const getCartWeight = () => {
    // Dans le script Apps Script, les tarifs sont basés sur le montant total.
    // Cette fonction pourrait être utilisée si le tarif dépendait du nombre d'articles ou du poids.
    // Ici, on retourne le total pour le calcul basé sur le montant.
    return totalCart; // On utilise le total du panier (Subtotal + Shipping déjà ajouté)
};

const calculateAndDisplayShipping = (zone, forceUpdate = false) => {
    const shippingOptionsContainer = document.getElementById('shipping-options-container');
    const shippingOptionsEl = document.getElementById('shipping-options');
    
    if (!zone || cart.length === 0) {
        shippingOptionsContainer.classList.add('hidden');
        shippingCost = 0;
        selectedShippingRate = null;
        updateCartDisplays();
        return;
    }

    const subtotal = getCartTotal(); // Le montant utilisé pour déterminer la tranche

    let rates = getApplicableRates(zone);
    if (rates.length === 0) {
        shippingOptionsEl.innerHTML = `<p class="text-red-500">Aucun mode de livraison disponible pour cette zone.</p>`;
        shippingOptionsContainer.classList.remove('hidden');
        shippingCost = 0;
        selectedShippingRate = null;
        updateCartDisplays();
        return;
    }
    
    shippingOptionsContainer.classList.remove('hidden');
    shippingOptionsEl.innerHTML = '';
    
    let bestRate = null;
    let ratesHtml = '';
    
    rates.forEach(rate => {
        // Appliquer la logique de la tranche de prix
        if (subtotal <= rate.maxAmount) {
            // C'est le tarif applicable. Le script Apps Script garantit que les tranches sont ordonnées.
            // On prend le premier tarif qui correspond.
            if (!bestRate) bestRate = rate;

            const isChecked = selectedShippingRate && selectedShippingRate.rateId === rate.rateId;
            
            ratesHtml += `
                <label class="flex items-center space-x-2 p-2 border rounded-md cursor-pointer ${isChecked ? 'border-primary bg-yellow-50' : 'hover:bg-gray-50'}">
                    <input type="radio" name="shipping-rate" value="${rate.rateId}" 
                           data-cost="${rate.cost}"
                           data-name="${rate.method}"
                           ${isChecked ? 'checked' : ''}
                           onchange="updateShippingSelection(this)" 
                           class="text-primary focus:ring-primary">
                    <span class="flex-grow">${rate.method} (${rate.details})</span>
                    <span class="font-bold">${formatPrice(rate.cost)}</span>
                </label>
            `;
        }
    });

    if (ratesHtml === '') {
        // Cela signifie que le montant est supérieur à la tranche maximale gérée
         shippingOptionsEl.innerHTML = `<p class="text-red-500 font-semibold">Le montant de votre commande (${formatPrice(subtotal)}) dépasse notre tranche de livraison maximale pour ${zone}. Veuillez nous contacter.</p>`;
         shippingCost = 0;
         selectedShippingRate = null;
    } else {
        shippingOptionsEl.innerHTML = ratesHtml;
        // Si la zone change ou si le panier change et que l'ancien taux n'est plus valide, on reset.
        if (forceUpdate || !selectedShippingRate || !document.querySelector(`input[value="${selectedShippingRate.rateId}"]:checked`)) {
            // Sélectionner par défaut la première option affichée (la meilleure si les tranches sont bien configurées)
             const firstRadio = document.querySelector('input[name="shipping-rate"]');
             if(firstRadio) {
                firstRadio.checked = true;
                updateShippingSelection(firstRadio);
             } else {
                // Si aucune option ne correspond, le HTML est vide (géré ci-dessus), on reset.
                shippingCost = 0;
                selectedShippingRate = null;
             }
        }
    }
    
    updateCartDisplays(); // Mise à jour après calcul/sélection des frais de port
};

const updateShippingSelection = (radioElement) => {
    shippingCost = parseFloat(radioElement.dataset.cost);
    selectedShippingRate = {
        rateId: radioElement.value,
        cost: shippingCost,
        method: radioElement.dataset.name,
        details: document.querySelector(`label:has(input[value="${radioElement.value}"]) > span:nth-child(2)`).textContent // Récupérer le nom complet
    };
    
    document.getElementById('shipping-method-name').textContent = selectedShippingRate.method;
    document.getElementById('shipping-cost').textContent = formatPrice(shippingCost);
    document.getElementById('shipping-display').classList.remove('hidden');
    
    // Réactualiser le total du panier
    updateCartDisplays();
};
// =========================================================================================
// PARTIE 7 : JAVASCRIPT - INITIALISATION ET ÉCOUTEURS D'ÉVÉNEMENTS (CORRIGÉ DE LA SYNTAXE)
// =========================================================================================

/**
 * Construit l'objet payload pour la création de commande
 */
const buildCreateOrderPayload = (paymentMethod, shippingRateId) => {
    const prenom = document.getElementById('prenom').value.trim();
    const nom = document.getElementById('nom').value.trim();
    const telephone = document.getElementById('telephone').value.trim();
    const email = document.getElementById('email').value.trim();
    const commune = document.getElementById('commune').value.trim();
    const cp = document.getElementById('cp').value.trim();
    const adresse = document.getElementById('adresse').value.trim();
    const adresseComplement = document.getElementById('adresse-complement').value.trim();
    const shippingZone = document.getElementById('shipping-zone').value;

    if (cart.length === 0) throw new Error("Panier vide.");
    
    let finalShippingCost = 0;
    let finalShippingMethod = "Retrait en magasin / Non spécifié";

    if (shippingRateId) {
        finalShippingCost = selectedShippingRate.cost;
        finalShippingMethod = selectedShippingRate.method + " (" + shippingZone + ")";
    } else {
        // Cette erreur est capturée par la validation de SumUp/Virement
        throw new Error("Missing shipping selection"); 
    }
    
    const subtotal = getCartTotal(); // Le sous-total (sans frais de port)

    const payload = {
        prenom, nom, telephone, email,
        commune, cp, adresse, adresseComplement, shippingZone,
        cart: cart.map(item => ({
            id: item.id,
            masterName: item.masterName,
            size: item.size,
            price: item.price,
            quantity: item.quantity,
            stock: item.stock
        })),
        totalFinal: subtotal + finalShippingCost,
        fraisLivraison: finalShippingCost,
        methodePaiement: paymentMethod,
        modeLivraison: finalShippingMethod,
        recaptchaToken: grecaptcha.getResponse()
    };
    
    return payload;
};

/**
 * Gère le changement de méthode de paiement (visibilité des boutons)
 */
const handlePaymentMethodChange = () => {
    const method = document.getElementById('payment-method').value;
    
    document.getElementById('paypal-button-container').classList.add('hidden');
    document.getElementById('sumup-btn').classList.add('hidden');
    document.getElementById('virement-info').classList.add('hidden');
    document.getElementById('btn-submit-quick').classList.add('hidden');

    if (method === 'paypal') {
        document.getElementById('paypal-button-container').classList.remove('hidden');
    } else if (method === 'sumup') {
        document.getElementById('sumup-btn').classList.remove('hidden');
    } else if (method === 'virement') {
        document.getElementById('virement-info').classList.remove('hidden');
        document.getElementById('btn-submit-quick').classList.remove('hidden');
    }
};

/**
 * Gère l'inscription à la newsletter
 */
const handleNewsletterSignup = async (e) => {
    e.preventDefault();
    const emailInput = document.getElementById('newsletter-email');
    const messageEl = document.getElementById('newsletter-message');
    const email = emailInput.value.trim();
    
    if (!email) {
        messageEl.textContent = "Veuillez entrer une adresse email.";
        messageEl.className = 'mt-2 text-sm italic text-red-400';
        return;
    }
    
    try {
        const data = await postNewsletterSignup(email);
        
        if (data.success) {
            messageEl.textContent = "Merci ! Votre inscription est confirmée.";
            messageEl.className = 'mt-2 text-sm italic text-green-400';
            emailInput.value = '';
        } else {
            messageEl.textContent = data.error || "Erreur lors de l'inscription. Réessayez.";
            messageEl.className = 'mt-2 text-sm italic text-red-400';
        }
    } catch (e) {
        messageEl.textContent = "Erreur réseau. Veuillez réessayer plus tard.";
        messageEl.className = 'mt-2 text-sm italic text-red-400';
        console.error('Newsletter error:', e);
    }
};


/**
 * Fonction d'initialisation
 */
const init = async () => {
    await fetchShippingRates(); // Charger les tarifs de livraison
    await fetchProducts();      // Charger les produits et faire le rendu
    updateCartDisplays();       // Charger le panier depuis le localStorage
    handlePaymentMethodChange(); // Initialiser l'affichage du paiement
    
    // Écouteur pour le changement de zone de livraison
    document.getElementById('shipping-zone').addEventListener('change', (e) => {
        calculateAndDisplayShipping(e.target.value, true);
    });
};


// Écouteurs d'événements DOM (appelés après chargement du DOM)
document.addEventListener('DOMContentLoaded', () => {

    // PayPal (Rendu des boutons)
    if(typeof paypal !== 'undefined') {
        paypal.Buttons({
            createOrder: function(data, actions) {
                if (cart.length === 0) return alert('Votre panier est vide.');
                if (!document.getElementById('checkout-form').checkValidity()) {
                    alert("Veuillez remplir tous les champs obligatoires du formulaire de livraison.");
                    document.getElementById('checkout-form').reportValidity();
                    throw new Error("Formulaire incomplet");
                }
                if (!selectedShippingRate) {
                    alert("Veuillez sélectionner un mode de livraison.");
                    throw new Error("Missing shipping selection");
                }
                const payload = buildCreateOrderPayload('paypal', selectedShippingRate.rateId);
                
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: payload.totalFinal.toFixed(2),
                            currency_code: 'EUR',
                            breakdown: {
                                item_total: { currency_code: 'EUR', value: (payload.totalFinal - payload.fraisLivraison).toFixed(2) },
                                shipping: { currency_code: 'EUR', value: payload.fraisLivraison.toFixed(2) }
                            }
                        },
                        items: payload.cart.map(item => ({
                            name: `${item.masterName} T. ${item.size}`,
                            quantity: item.quantity,
                            unit_amount: { currency_code: 'EUR', value: item.price.toFixed(2) }
                        }))
                    }]
                });
            },
            onApprove: async function(data, actions) {
                // Capturer la transaction (géré côté PayPal)
                const details = await actions.order.capture();
                
                // Préparer le payload de commande final pour Apps Script
                const payload = buildCreateOrderPayload('paypal', selectedShippingRate.rateId);
                
                try {
                    const orderData = await postCreateOrder({
                        ...payload,
                        checkoutId: details.id,
                        paypalDetails: details // Inclure les détails PayPal
                    });

                    if (orderData.success) {
                        showConfirmationAndClear(payload.prenom);
                    } else {
                        alert('Paiement réussi mais erreur à la confirmation de commande. Contactez-nous avec l\'ID PayPal: ' + details.id);
                        console.error('Order Confirmation Error:', orderData);
                    }
                } catch (e) {
                    console.error('createOrder err', e);
                    alert('Erreur réseau lors de la finalisation de la commande.');
                }
            },
            onError: function(err) {
                console.error('PayPal Error:', err);
                alert('Erreur de paiement PayPal. Veuillez réessayer.');
            }
        }).render('#paypal-button-container');
    }

    // Modal Image
    document.getElementById('prev-img').addEventListener('click', (e) => { e.stopPropagation(); changeImage(-1); });
    document.getElementById('next-img').addEventListener('click', (e) => { e.stopPropagation(); changeImage(1); });
    document.getElementById('close-img-modal').addEventListener('click', () => { document.getElementById('img-modal').style.display = 'none'; });

    // Panier (Ouverture/Fermeture)
    document.getElementById('cart-button').addEventListener('click', () => {
        document.getElementById('cart-drawer').classList.toggle('cart-open');
        document.getElementById('cart-drawer').classList.toggle('cart-closed');
    });
    document.getElementById('close-cart-button').addEventListener('click', () => {
        document.getElementById('cart-drawer').classList.remove('cart-open');
        document.getElementById('cart-drawer').classList.add('cart-closed');
    });

    // Checkout (Ouverture/Fermeture)
    document.getElementById('checkout-button').addEventListener('click', () => {
        document.getElementById('checkout-overlay').classList.remove('hidden');
    });
    document.getElementById('close-checkout-button').addEventListener('click', () => {
        document.getElementById('checkout-overlay').classList.add('hidden');
    });

    // Écouteur Virement Bancaire (btn-submit-quick)
    document.getElementById('btn-submit-quick').addEventListener('click', async () => {
        if (cart.length === 0) {
            alert('Votre panier est vide.');
            return;
        }
        if (!document.getElementById('checkout-form').checkValidity()) {
            alert("Veuillez remplir tous les champs obligatoires du formulaire de livraison.");
            document.getElementById('checkout-form').reportValidity();
            return;
        }
        if (!selectedShippingRate) {
            alert("Veuillez sélectionner un mode de livraison.");
            return;
        }

        const token = grecaptcha.getResponse();
        if (!token) return alert('Veuillez compléter le reCAPTCHA.');
        
        try {
            const payload = buildCreateOrderPayload('virement', selectedShippingRate.rateId);
            const data = await postCreateOrder(payload);
            if(data.success){ showConfirmationAndClear(payload.prenom); } else { alert('Erreur création commande: ' + (data.error || data.message || 'Erreur')); console.error(data); }
        } catch(e){ 
            if(e.message !== "Missing shipping selection") console.error('createOrder err', e); 
            if(e.message !== "Missing shipping selection") alert('Erreur réseau / Panier vide.'); 
        }
    });
    
    // NOUVEAU : Bouton SumUp
    document.getElementById('sumup-btn').addEventListener('click', handleSumUpCheckout);

    // Virement Info
    document.getElementById('virement-button').addEventListener('click', ()=>{ 
        document.getElementById('virement-info').classList.toggle('hidden');
    });

    // Vider le panier (les deux boutons)
    document.getElementById('btn-clear-cart').addEventListener('click', ()=>{ 
        if(confirm('Vider le panier ?')){ cart=[]; updateCartDisplays(); handlePaymentMethodChange(); calculateAndDisplayShipping(document.getElementById('shipping-zone').value, true); }
    });
    document.getElementById('btn-clear-cart-default').addEventListener('click', ()=>{
        if(confirm('Vider le panier ?')){ cart=[]; updateCartDisplays(); handlePaymentMethodChange(); calculateAndDisplayShipping(document.getElementById('shipping-zone').value, true); }
    });
    
    // Écouteur Newsletter
    document.getElementById('newsletter-form').addEventListener('submit', handleNewsletterSignup);

    // Initialisation au chargement de la page
    init();
  
}); // <--- FERMETURE FINALE DU document.addEventListener('DOMContentLoaded', ...);


</script>
</body>
</html>
