<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kicks - Boutique</title>

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://www.google.com/recaptcha/api.js?hl=fr" async defer></script>
<script src="https://www.paypal.com/sdk/js?client-id=AXd7iZon2xRzhIauBjGdjwxQk237evP3BTtNfqIKpEaYDTOk9S733o-_GcPQIqhZ7bCalMG-M_PNaRHG&currency=EUR" data-sdk-integration-source="button-factory"></script>
<script type="text/javascript" src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>

<style>
  :root{
    --orange:#FFA133;
    --anthracite:#1a1a1a;
    --white:#ffffff;
    --paypal:#003087;
    --whatsapp: #25D366;
    --bg:#f8f8f8;
  }
  html,body{ height:100%; margin:0; padding:0; background:var(--bg); font-family:Inter,system-ui,Arial,Helvetica,sans-serif; color:#111; -webkit-font-smoothing:antialiased; }
  .text-orange{ color:var(--orange); }
  .bg-orange{ background-color:var(--orange); }
  .hover-bg-orange:hover{ background-color:var(--orange); }
  .focus-ring-orange:focus{ --tw-ring-color: var(--orange); }
  .border-orange{ border-color:var(--orange); }
  .text-anthracite{ color:var(--anthracite); }
  .border-anthracite{ border-color:var(--anthracite); }
  .hover-bg-anthracite:hover{ background-color:var(--anthracite); }
  .text-whatsapp{ color:var(--whatsapp); }
  .text-paypal{ color:var(--paypal); }
  .text-xs-force{ font-size: 0.7rem !important; }

  /* Pour cacher la colonne de droite sur mobile par défaut */
  @media (max-width: 1023px) {
    #form-paiement-modal { display: none; }
  }

  /* Pour afficher la modal d'image en plein écran */
  #img-modal {
    position: fixed; top: 0; left: 0; z-index: 50;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    display: none; /* Cacher par défaut */
    align-items: center; justify-content: center;
  }
  #img-modal img { max-height: 90vh; max-width: 90vw; object-fit: contain; }
  .modal-close-btn { position: absolute; top: 20px; right: 40px; color: white; font-size: 2rem; cursor: pointer; }
</style>

</head>
<body>
<div id="app" class="min-h-screen bg-gray-50 flex flex-col">
  <header class="bg-white shadow-md sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
      <h1 class="text-2xl font-extrabold text-orange">KICKS BOUTIQUE</h1>
      <div class="flex items-center space-x-4">
        <button onclick="document.getElementById('form-paiement-modal').style.display = 'block'; updateCartDisplays();" class="p-2 bg-orange text-white rounded-full hover:bg-anthracite transition duration-200 lg:hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-grow max-w-7xl mx-auto w-full lg:flex lg:space-x-8 p-4 sm:p-6 lg:p-8">
    
    <div class="lg:w-2/3">
        <section class="mb-8">
            <h2 class="text-3xl font-bold text-anthracite mb-6">Nos Produits</h2>
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                </div>
            <p id="loading-message" class="text-center mt-8 text-gray-500">Chargement des produits...</p>
        </section>

        <section id="panier-mobile" class="lg:hidden p-4 mt-8 bg-white shadow-lg rounded-lg border border-gray-200">
            <h2 class="text-xl font-bold text-anthracite mb-4">Votre Panier</h2>
            <div id="cart-items-list-mobile" class="space-y-4">
                 </div>
            <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                <div class="flex justify-between items-center text-sm">
                    <span>Sous-total:</span>
                    <span id="cart-subtotal-mobile">0.00 €</span>
                </div>
                <div class="flex justify-between items-center text-sm border-b pb-2 mb-2">
                    <span>Frais de port:</span>
                    <span id="cart-shipping-mobile">0.00 €</span>
                </div>
                <div class="flex justify-between font-bold text-lg pt-2">
                    <span>Total (TTC):</span>
                    <span id="cart-total-mobile">0.00 €</span>
                </div>
            </div>
            <button onclick="document.getElementById('form-paiement-modal').style.display = 'block'; updateCartDisplays();" class="mt-4 w-full bg-orange text-white py-3 rounded-md font-semibold hover:bg-anthracite transition duration-200">
                Finaliser la Commande
            </button>
            <button id="btn-clear-cart-default" class="mt-2 w-full text-red-500 text-sm hover:text-red-700">Vider le panier</button>
        </section>

    </div>

    <aside id="form-paiement-modal" class="lg:w-1/3 lg:sticky lg:top-20 h-full bg-white shadow-2xl rounded-lg p-6 border-l border-gray-100 absolute lg:relative top-0 left-0 w-full z-20">
      <button onclick="document.getElementById('form-paiement-modal').style.display='none';" class="modal-close-btn text-anthracite hover:text-orange lg:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>

      <h2 class="text-2xl font-bold text-anthracite mb-6 border-b pb-3">Récapitulatif & Paiement</h2>
      
      <div id="cart-items-list" class="space-y-3 max-h-48 overflow-y-auto mb-4">
          </div>
      
      <div class="border-t pt-4 space-y-2">
          <div class="flex justify-between items-center text-sm">
              <span>Sous-total:</span>
              <span id="cart-subtotal">0.00 €</span>
          </div>
          <div class="flex justify-between items-center text-sm border-b pb-2 mb-2">
              <span>Frais de port:</span>
              <span id="cart-shipping">0.00 €</span>
          </div>
          <div class="flex justify-between font-bold text-lg pt-2">
              <span>Total final (TTC):</span>
              <span id="cart-total" class="text-orange">0.00 €</span>
          </div>
      </div>
      
      <button id="btn-clear-cart" class="w-full mt-4 text-red-500 text-sm hover:text-red-700">Vider le panier</button>

      <form id="checkout-form" class="mt-6 space-y-4">
        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Informations Client</h3>
        <div class="grid grid-cols-2 gap-4">
            <input type="text" id="prenom" placeholder="Prénom" required class="p-3 border rounded-md w-full">
            <input type="text" id="nom" placeholder="Nom" required class="p-3 border rounded-md w-full">
        </div>
        <input type="email" id="email" placeholder="Email" required class="p-3 border rounded-md w-full">
        <input type="tel" id="telephone" placeholder="Téléphone (ex: 0690xxxxxx)" required class="p-3 border rounded-md w-full">

        <div id="shipping-options-container" class="my-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h2>Options de Livraison</h2>
            <p class="text-gray-500 text-sm mt-1">Chargement des tarifs...</p>
        </div>
        <input type="text" id="adresse" placeholder="Adresse complète" required class="p-3 border rounded-md w-full">
        <input type="text" id="commune-cp" placeholder="Ville et Code Postal" required class="p-3 border rounded-md w-full">
        
        <input type="hidden" id="total-final-client-input" value="0.00">
        <input type="hidden" id="nombre-articles-total" value="0">
        <input type="hidden" id="payment-method" value="virement">
        
        <h3 class="text-xl font-semibold mb-4 border-b pb-2 pt-4">Paiement</h3>
        <div class="space-y-4">
            <p class="text-xl font-bold text-center p-3 rounded-md bg-orange text-white">
                Total à payer : <span id="form-total-text">0.00 €</span>
            </p>

            <button type="button" id="sumup-btn" class="w-full py-3 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition duration-200 flex items-center justify-center space-x-2" style="background-color: #003087;">
                Payer par Carte
            </button>

            <div id="paypal-button-container" data-rendered="false" class="flex justify-center mt-2"></div>

            <button type="button" id="virement-button" class="w-full py-3 bg-anthracite text-white rounded-md font-semibold hover:opacity-90 transition duration-200">
                Payer par Virement
            </button>
            <div id="virement-info" class="hidden p-4 bg-gray-100 rounded-md text-sm border border-gray-300">
                <p class="font-bold mb-2">Détails du Virement Bancaire</p>
                <p><strong>Banque:</strong> SumUp Limited</p>
                <p><strong>IBAN:</strong> IE85SUMU99010078239088</p>
                <p><strong>Bénéficiaire:</strong> E.I.RL Kicks</p>
                <p class="mt-3 text-red-500">Votre commande sera traitée après réception du paiement. Veuillez indiquer votre nom en référence.</p>
            </div>
        </div>

        <div class="flex justify-center pt-4">
            <div class="g-recaptcha" data-sitekey="6LcBZwosAAAAAG8xMR5po1FuipWeEo-_mJlROYFN"></div>
        </div>

        <button type="button" id="btn-submit-quick" class="w-full py-3 bg-orange text-white rounded-md font-semibold hover:bg-anthracite transition duration-200 mt-4">
            Confirmer la Commande (Virement)
        </button>
      </form>
    </aside>
  </main>

  <section class="bg-anthracite text-white py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl font-bold mb-4">Abonnez-vous à notre Newsletter</h2>
        <p class="mb-6">Recevez les dernières nouveautés et offres spéciales directement dans votre boîte mail.</p>
        <form id="newsletter-form" class="max-w-md mx-auto flex space-x-2">
            <input type="email" id="newsletter-email" placeholder="Votre adresse e-mail" required class="p-3 flex-grow rounded-l-md text-gray-800">
            <button type="submit" class="p-3 bg-orange rounded-r-md font-semibold hover:bg-white hover:text-orange transition duration-200">S'abonner</button>
        </form>
        <p id="newsletter-message" class="mt-4 text-green-400 hidden"></p>
    </div>
  </section>

  <footer class="bg-anthracite text-gray-400 py-6 border-t border-gray-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
        <p>© 2025 Kicks Boutique. Tous droits réservés.</p>
    </div>
  </footer>
</div>

<div id="img-modal">
  <span class="modal-close-btn">&times;</span>
  <img id="modal-image" src="" alt="Aperçu du produit">
  <button id="prev-img-btn" class="absolute left-10 p-4 text-white bg-black bg-opacity-50 rounded-full text-2xl z-50">&#10094;</button>
  <button id="next-img-btn" class="absolute right-10 p-4 text-white bg-black bg-opacity-50 rounded-full text-2xl z-50">&#10095;</button>
</div>

<script>
/* ==================================================================
 * MODIFICATIONS JAVASCRIPT À FAIRE DANS chatgpt6.html
 * ================================================================== */
// Variables et Cartographie
const API_URL = 'https://script.google.com/macros/s/AKfycbz24YH__hL1LyO_Nsl76a40lr8R6Rl5wC3fk1fmzdj5KYwGPC5yTymc847YSxP6IcP/exec'; // <-- NOUVELLE URL COLLÉE ICI
let cart = [];
let products = [];
let shippingRates = []; // NOUVEAU : Stocke les tarifs de livraison
let selectedShipping = null; // NOUVEAU : Le tarif de livraison sélectionné
let currentModal = { product: null, imgIndex: 0 };
// Référence du conteneur de produits
const productContainer = document.getElementById('product-list');

// --- FONCTIONS DE BASE (Inchangées dans leur corps) ---

// Fonction POST générique
async function postData(payload) {
    const response = await fetch(API_URL, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-cache',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(payload)
    });
    return response.json();
}

// Fonction pour récupérer les produits (getProduits)
async function fetchProducts() {
    try {
        const response = await fetch(`${API_URL}?action=getProduits`);
        const data = await response.json();
        document.getElementById('loading-message').style.display = 'none';
        if(data.success) {
            products = data.produits;
            renderProducts(products);
        } else {
            console.error('Erreur lors de la récupération des produits:', data.error);
            productContainer.innerHTML = '<p class="text-red-500 text-center col-span-full">Erreur: Impossible de charger les produits. Veuillez réessayer.</p>';
        }
    } catch(error) {
        console.error('Erreur réseau fetchProducts:', error);
        productContainer.innerHTML = '<p class="text-red-500 text-center col-span-full">Erreur réseau: Impossible de communiquer avec le serveur.</p>';
    }
}

// NOUVELLE FONCTION: Récupérer les tarifs de livraison
async function fetchShippingRates() {
    try {
        const response = await fetch(`${API_URL}?action=getShippingRates`);
        const data = await response.json();
        if(data.success) {
            shippingRates = data.rates;
            updateShippingOptions(shippingRates); // Appelle la nouvelle fonction de mise à jour HTML
        } else {
            console.error('Erreur lors de la récupération des tarifs de livraison:', data.error);
            document.getElementById('shipping-options-container').innerHTML = `<p class="text-red-500 text-sm mt-1">Erreur: Impossible de charger les tarifs de livraison. ${data.error}</p>`;
        }
    } catch(error) {
        console.error('Erreur réseau fetchShippingRates:', error);
        document.getElementById('shipping-options-container').innerHTML = `<p class="text-red-500 text-sm mt-1">Erreur réseau: Impossible de communiquer avec le serveur pour les tarifs.</p>`;
    }
}

// NOUVELLE FONCTION: Mettre à jour les options de livraison dans le formulaire
function updateShippingOptions(rates) {
    const container = document.getElementById('shipping-options-container');
    if (!container) return; 

    container.innerHTML = '<h2>Options de Livraison</h2>';
    const zones = {};

    // 1. Grouper par Zone (pour les menus déroulants)
    rates.forEach(rate => {
        if (!zones[rate.zone]) { zones[rate.zone] = {}; }
        if (!zones[rate.zone][rate.mode]) { zones[rate.zone][rate.mode] = []; }
        zones[rate.zone][rate.mode].push(rate);
    });

    let html = `
        <div class="space-y-4">
            <div>
                <label for="shipping-zone" class="block text-sm font-medium text-gray-700">Zone de Livraison</label>
                <select id="shipping-zone" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-orange focus:border-orange sm:text-sm rounded-md bg-white" required>
                    <option value="" disabled selected>Sélectionnez votre zone...</option>
                    ${Object.keys(zones).map(zone => `<option value="${zone}">${zone.replace(/_/g, ' ')}</option>`).join('')}
                </select>
            </div>
            <div id="mode-livraison-div" class="hidden">
                <label for="shipping-mode" class="block text-sm font-medium text-gray-700">Mode de Livraison</label>
                <select id="shipping-mode" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-orange focus:border-orange sm:text-sm rounded-md bg-white" required>
                    <option value="" disabled selected>Sélectionnez le mode...</option>
                </select>
                <p id="shipping-details" class="mt-2 text-xs text-gray-500"></p>
            </div>
        </div>
    `;
    container.innerHTML = html;
    
    // 2. Écouteurs d'événements pour la sélection
    document.getElementById('shipping-zone').addEventListener('change', (e) => {
        const selectedZone = e.target.value;
        const modeSelect = document.getElementById('shipping-mode');
        const modeDiv = document.getElementById('mode-livraison-div');
        modeSelect.innerHTML = '<option value="" disabled selected>Sélectionnez le mode...</option>';
        selectedShipping = null; // Réinitialiser
        modeDiv.classList.add('hidden');
        document.getElementById('shipping-details').textContent = '';
        updateCartDisplays(); // Réinitialiser le total

        if (selectedZone && zones[selectedZone]) {
            modeDiv.classList.remove('hidden');
            Object.keys(zones[selectedZone]).forEach(mode => {
                modeSelect.innerHTML += `<option value="${mode}">${mode.replace(/_/g, ' ')}</option>`;
            });
        }
    });

    document.getElementById('shipping-mode').addEventListener('change', (e) => {
        const selectedZone = document.getElementById('shipping-zone').value;
        const selectedMode = e.target.value;
        
        // Trouver la tranche tarifaire (simplifiée pour l'affichage initial)
        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const rate = rates.find(r => 
            r.zone === selectedZone && 
            r.mode === selectedMode &&
            total >= r.min && 
            total <= r.max
        );

        if (rate) {
            selectedShipping = rate;
            document.getElementById('shipping-details').textContent = `Tarif trouvé pour un sous-total de ${total.toFixed(2)}€ : ${rate.cost.toFixed(2)} €`;
        } else {
            selectedShipping = null;
            document.getElementById('shipping-details').textContent = 'Attention: Aucun tarif précis trouvé pour ce panier/mode. La validation serveur s\'appliquera.';
        }
        updateCartDisplays();
    });
}
// ... (le reste du script continue dans la partie 3)
// Fonction pour l'ajout au panier (Inchangée)
function addToCart(id) {
    const product = products.find(p => p.id === id);
    if (!product) return alert('Produit non trouvé.');

    // Vérifier le stock avant d'ajouter
    if (product.stock <= 0) return alert('Ce produit est actuellement en rupture de stock.');

    const cartItem = cart.find(item => item.id === id);
    if (cartItem) {
        if (cartItem.quantity < product.stock) {
            cartItem.quantity++;
        } else {
            return alert(`Stock maximum atteint pour ${product.masterName} (Taille ${product.size}).`);
        }
    } else {
        cart.push({
            id: product.id,
            name: product.masterName,
            size: product.size,
            price: product.price,
            quantity: 1
        });
    }
    updateCartDisplays();
    alert(`Ajouté au panier: ${product.masterName} (Taille ${product.size})`);
}

// Fonctions pour changer la quantité et retirer (Inchangées)
function changeQuantity(id, change) {
    const cartItem = cart.find(item => item.id === id);
    if (!cartItem) return;

    const product = products.find(p => p.id === id);
    if (!product) return;

    cartItem.quantity += change;

    if (cartItem.quantity <= 0) {
        removeItem(id);
        return;
    }
    
    // Vérification de stock pour l'augmentation
    if (cartItem.quantity > product.stock) {
         cartItem.quantity = product.stock;
         return alert(`Stock maximum atteint pour ${product.masterName} (Taille ${product.size}).`);
    }

    updateCartDisplays();
}

function removeItem(id) {
    cart = cart.filter(item => item.id !== id);
    updateCartDisplays();
}

// Fonction de rendu des produits (Inchangée dans son principe)
function renderProducts(products) {
    let html = '';
    products.forEach(p => {
        // Logique pour déterminer l'image principale (Image 1)
        const imageUrl = p.imageUrls && p.imageUrls[0] ? p.imageUrls[0] : 'placeholder.png';
        const inStockClass = p.stock > 0 ? '' : 'opacity-50 pointer-events-none';
        const stockText = p.stock > 0 ? `Stock: ${p.stock}` : 'Rupture de stock';
        const buttonText = p.stock > 0 ? 'Ajouter au panier' : 'Indisponible';

        html += `
            <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden ${inStockClass}">
                <div class="relative cursor-pointer" onclick="openImageModal('${p.id}', 0)">
                    <img src="${imageUrl}" alt="${p.masterName} (Taille ${p.size})" class="w-full h-48 object-cover">
                    <span class="absolute top-2 right-2 bg-orange text-white text-xs font-bold px-3 py-1 rounded-full">${p.price.toFixed(2)} €</span>
                </div>
                <div class="p-4">
                    <h3 class="font-semibold text-lg mb-1 truncate">${p.masterName} (Taille ${p.size})</h3>
                    <p class="text-sm text-gray-500 mb-3 h-10 overflow-hidden">${p.seoDescription || 'Description non disponible.'}</p>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm ${p.stock > 0 ? 'text-green-600' : 'text-red-600'} font-medium">${stockText}</span>
                    </div>
                    <button onclick="addToCart('${p.id}')" class="w-full bg-anthracite text-white py-2 rounded-md font-semibold hover:bg-orange transition duration-200 disabled:opacity-50" ${p.stock <= 0 ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </div>
            </div>
        `;
    });
    productContainer.innerHTML = html;
}

// Mise à Jour de la Fonction updateCartDisplays (MODIFIÉE)
function updateCartDisplays() {
    const cartList = document.getElementById('cart-items-list');
    const cartListMobile = document.getElementById('cart-items-list-mobile');
    cartList.innerHTML = '';
    cartListMobile.innerHTML = '';
    let subtotal = 0;
    let totalItems = 0;

    cart.forEach(item => {
        subtotal += item.price * item.quantity;
        totalItems += item.quantity;
        
        const productDiv = document.createElement('div');
        productDiv.className = 'flex justify-between items-center py-2 border-b';
        productDiv.innerHTML = `
            <div class="flex-1">
                <p class="font-medium">${item.name} (Taille ${item.size})</p>
                <p class="text-sm text-gray-500">${item.price.toFixed(2)} € x ${item.quantity}</p>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="changeQuantity('${item.id}', -1)" class="text-gray-500 hover:text-orange text-lg font-bold">-</button>
                <span class="font-semibold w-6 text-center">${item.quantity}</span>
                <button onclick="changeQuantity('${item.id}', 1)" class="text-gray-500 hover:text-orange text-lg font-bold">+</button>
                <button onclick="removeItem('${item.id}')" class="text-red-500 hover:text-red-700 ml-2 text-xl">x</button>
            </div>
        `;
        cartList.appendChild(productDiv.cloneNode(true));
        cartListMobile.appendChild(productDiv);
    });
    
    // DÉBUT DE LA MODIFICATION
    let shippingCost = selectedShipping ? selectedShipping.cost : 0; // Utilise le tarif sélectionné, sinon 0
    let totalFinal = subtotal + shippingCost;
    // FIN DE LA MODIFICATION

    // Mettre à jour l'affichage du panier (Partie droite)
    document.getElementById('cart-subtotal').textContent = `${subtotal.toFixed(2)} €`;
    document.getElementById('cart-shipping').textContent = `${shippingCost.toFixed(2)} €`; 
    document.getElementById('cart-total').textContent = `${totalFinal.toFixed(2)} €`;
    
    // Mettre à jour l'affichage du panier (Partie mobile)
    document.getElementById('cart-subtotal-mobile').textContent = `${subtotal.toFixed(2)} €`;
    document.getElementById('cart-shipping-mobile').textContent = `${shippingCost.toFixed(2)} €`; 
    document.getElementById('cart-total-mobile').textContent = `${totalFinal.toFixed(2)} €`;
    
    // Mettre à jour les champs cachés du formulaire
    document.getElementById('total-final-client-input').value = totalFinal.toFixed(2);
    document.getElementById('nombre-articles-total').value = totalItems;
    
    // Mettre à jour l'affichage dans le formulaire (Partie droite)
    document.getElementById('form-total-text').textContent = `${totalFinal.toFixed(2)} €`;

    // Mettre à jour l'état du bouton PayPal
    handlePaymentMethodChange(); 
    
    // Réinitialiser le SumUp pour le nouveau total (si déjà initialisé)
    const sumupBtn = document.getElementById('sumup-btn');
    if (sumupBtn && sumupBtn.dataset.initialized === 'true') {
        sumupBtn.dataset.initialized = 'false';
    }

    // Réappliquer le listener pour les options de livraison
    // Ceci est nécessaire si le conteneur a été mis à jour par updateShippingOptions après un appel à updateCartDisplays
    if (shippingRates.length > 0 && selectedShipping === null) {
        document.getElementById('shipping-details').textContent = 'Veuillez sélectionner le Mode de Livraison.';
    }
}

// Fonction auxiliaire pour le payload PayPal (Inchangée)
function createPaypalOrderPayload(total) {
    return {
        intent: 'CAPTURE',
        purchase_units: [{
            amount: { currency_code: 'EUR', value: total.toFixed(2) },
            description: `Achat Kicks Boutique - Total: ${total.toFixed(2)} €`,
        }]
    };
}

// Fonction auxiliaire pour le texte récapitulatif (Inchangée)
function buildRecapText(cart) {
    let text = "Récapitulatif des articles:\n";
    cart.forEach(item => {
        text += `- ${item.name} (Taille ${item.size}) x ${item.quantity} à ${item.price.toFixed(2)} €\n`;
    });
    return text;
}

// Fonction auxiliaire pour le HTML récapitulatif (Inchangée)
function buildRecapHTML(cart) {
    let html = '<ul style="list-style:none; padding:0; margin:0;">';
    cart.forEach(item => {
        html += `<li style="margin-bottom: 5px;"><strong>${item.name}</strong> (Taille ${item.size}) x ${item.quantity} - ${item.price.toFixed(2)} €/u</li>`;
    });
    html += '</ul>';
    return html;
}

// Mise à Jour de la Fonction buildCreateOrderPayload (MODIFIÉE)
function buildCreateOrderPayload(methodePaiement, sumupCheckoutId = null, paypalOrderId = null) {
    if(cart.length === 0) throw new Error("Panier vide");
    
    // NOUVEAU : Récupération des données de livraison
    const zoneLivraison = document.getElementById('shipping-zone').value;
    const modeLivraison = document.getElementById('shipping-mode').value;
    
    // VÉRIFICATION CRITIQUE AVANT ENVOI
    if (!zoneLivraison || !modeLivraison) {
        alert("Veuillez sélectionner la Zone et le Mode de Livraison.");
        throw new Error("Missing shipping selection");
    }

    return {
        action: 'createOrder',
        recaptchaResponse: grecaptcha.getResponse(),
        methodePaiement: methodePaiement,
        sumupCheckoutId: sumupCheckoutId,
        paypalOrderId: paypalOrderId,
        
        // --- NOUVELLES DONNÉES DE LIVRAISON ---
        modeLivraison: modeLivraison,
        zoneLivraison: zoneLivraison,
        // -------------------------------------

        // Données Client
        prenom: document.getElementById('prenom').value,
        nom: document.getElementById('nom').value,
        email: document.getElementById('email').value,
        telephone: document.getElementById('telephone').value,
        adresse: document.getElementById('adresse').value,
        communeCP: document.getElementById('commune-cp').value,
        adresseComplete: `${document.getElementById('adresse').value}, ${document.getElementById('commune-cp').value}`,

        // Données Panier
        totalFinalClient: document.getElementById('total-final-client-input').value, // Utilise le champ mis à jour
        nombreArticlesTotal: document.getElementById('nombre-articles-total').value,
        productsJson: JSON.stringify(cart),
        recapText: buildRecapText(cart),
        recapHTML: buildRecapHTML(cart)
    };
}

// Fonction de confirmation (Inchangée)
function showConfirmationAndClear(prenom) {
    alert(`Merci ${prenom} ! Votre commande est enregistrée. Un email de confirmation a été envoyé.`);
    cart = [];
    updateCartDisplays();
    document.getElementById('checkout-form').reset();
    document.getElementById('virement-info').classList.add('hidden');
    document.getElementById('form-paiement-modal').style.display='none';
}

// Fonction de création de commande POST (Inchangée)
async function postCreateOrder(payload) {
    // Vérification des champs clients (simplifiée)
    if (!payload.prenom || !payload.nom || !payload.email || !payload.telephone || !payload.adresse || !payload.communeCP) {
        throw new Error('Veuillez compléter tous les champs client (Nom, Email, Adresse, Zone).');
    }
    const data = await postData(payload);
    
    // Décrémenter le stock si succès
    if(data.success) {
        const updateStockPayload = {
            action: 'updateStock',
            productsJson: payload.productsJson 
        };
        const stockData = await postData(updateStockPayload);
        if(!stockData.success) {
            console.warn('Erreur lors de la décrémentation de stock: ' + (stockData.error || stockData.message));
        }
    }

    return data;
}

// Fonction SumUp (Inchangée)
async function handleSumUpCheckout() {
    if(cart.length===0) return alert('Votre panier est vide.');
    const token = grecaptcha.getResponse();
    if(!token) return alert('Veuillez compléter le reCAPTCHA.');

    try {
        const payload = buildCreateOrderPayload('carte'); // Vérification de livraison incluse ici
        
        const total = parseFloat(payload.totalFinalClient);
        if(total <= 0) return alert('Le total de la commande doit être supérieur à 0.');

        const sumupCheckoutId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        
        // 1. Initialisation SumUp
        const checkout = new window.SumupCard.Checkout({
            amount: total,
            currency: 'EUR',
            title: 'Commande Kicks',
            checkoutId: sumupCheckoutId,
            onResponse: async (type, body) => {
                if (type === 'success') {
                    // 2. Création de la commande sur Google Sheet
                    const orderPayload = buildCreateOrderPayload('carte', sumupCheckoutId);
                    try{
                        const data = await postCreateOrder(orderPayload);
                        if(data.success){ showConfirmationAndClear(orderPayload.prenom); } else { alert('Erreur création commande (SumUp): ' + (data.error || data.message || 'Erreur')); console.error(data); }
                    } catch(e){ console.error('createOrder (SumUp) err', e); alert('Erreur réseau.'); }
                } else if (type === 'error') {
                    alert('Erreur de paiement par carte: ' + body.message);
                    console.error('SumUp Error:', body);
                }
            }
        });

        checkout.open();

    } catch(e) {
        console.error('handleSumUpCheckout err', e);
        if(e.message !== "Missing shipping selection") alert('Veuillez remplir correctement le formulaire et votre panier.');
    }
}

// Gestion des méthodes de paiement et PayPal rendu (Inchangée)
function handlePaymentMethodChange() {
    const totalFinal = parseFloat(document.getElementById('total-final-client-input').value);
    const paypalButtonContainer = document.getElementById('paypal-button-container');

    // Mettre à jour PayPal si un montant valide et le conteneur est visible
    if (totalFinal > 0 && paypalButtonContainer.closest('.hidden') === null) {
      if(paypalButtonContainer.dataset.rendered !== 'true'){
        paypal.Buttons({
          style: { layout: 'horizontal', color: 'blue', shape: 'rect', label: 'paypal', tagline: false },
          createOrder: function(data, actions) {
            return actions.order.create(createPaypalOrderPayload(totalFinal));
          },
          onApprove: async function(data, actions) {
            const order = await actions.order.capture();
            // Utiliser le buildCreateOrderPayload modifié
            const payload = buildCreateOrderPayload('paypal', null, order.id); 
            try{
                const orderData = await postCreateOrder(payload);
                if(orderData.success){ showConfirmationAndClear(payload.prenom); } else { alert('Erreur création commande (PayPal): ' + (orderData.error || orderData.message || 'Erreur')); console.error(orderData); }
            } catch(e){ console.error('createOrder (PayPal) err', e); alert('Erreur réseau.'); }
          },
          onError: function (err) { console.error('PayPal Checkout Error', err); alert('Une erreur est survenue lors du paiement PayPal.'); }
        }).render('#paypal-button-container');
        paypalButtonContainer.dataset.rendered = 'true';
      }
    }
}

// Fonctions modales (Inchangées)
function openImageModal(productId, initialIndex) {
    const p = products.find(prod => prod.id === productId);
    if (!p || !p.imageUrls || p.imageUrls.length === 0) return;
    
    currentModal.product = p;
    currentModal.imgIndex = initialIndex;
    
    document.getElementById('modal-image').src = p.imageUrls[initialIndex];
    document.getElementById('img-modal').style.display = 'flex';
}

function nextImage() {
    if (!currentModal.product) return;
    currentModal.imgIndex = (currentModal.imgIndex + 1) % currentModal.product.imageUrls.length;
    document.getElementById('modal-image').src = currentModal.product.imageUrls[currentModal.imgIndex];
}

function prevImage() {
    if (!currentModal.product) return;
    currentModal.imgIndex = (currentModal.imgIndex - 1 + currentModal.product.imageUrls.length) % currentModal.product.imageUrls.length;
    document.getElementById('modal-image').src = currentModal.product.imageUrls[currentModal.imgIndex];
}

// Logique Newsletter (Inchangée)
document.getElementById('newsletter-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('newsletter-email').value;
    const messageElement = document.getElementById('newsletter-message');
    
    const payload = { action: 'subscribeNewsletter', email: email };

    try {
        const data = await postData(payload);
        messageElement.classList.remove('hidden', 'text-red-500');
        messageElement.classList.add('text-green-400');
        if (data.success) {
            messageElement.textContent = 'Merci pour votre inscription !';
            document.getElementById('newsletter-form').reset();
        } else {
            messageElement.classList.remove('text-green-400');
            messageElement.classList.add('text-red-500');
            messageElement.textContent = data.error || 'Erreur d\'inscription.';
        }
    } catch(error) {
        messageElement.classList.remove('hidden', 'text-green-400');
        messageElement.classList.add('text-red-500');
        messageElement.textContent = 'Erreur réseau. Veuillez réessayer.';
    }
    
    setTimeout(() => { messageElement.classList.add('hidden'); }, 5000);
});

// INITIALISATION DU SCRIPT
async function init() {
    await fetchProducts();
    // NOUVEAU : Récupérer les tarifs de livraison au démarrage
    await fetchShippingRates(); 
    updateCartDisplays();
}

// Écouteurs globaux
document.addEventListener('DOMContentLoaded', () => {
  init();

  // Écouteurs Modal Image
  document.getElementById('next-img-btn').addEventListener('click', nextImage);
  document.getElementById('prev-img-btn').addEventListener('click', prevImage);
  document.getElementById('modal-image').addEventListener('click', (e) => { e.stopPropagation(); });
  document.getElementById('img-modal').addEventListener('click', (e)=>{ if(e.target.id === 'img-modal') document.getElementById('img-modal').style.display='none'; });

  // Écouteurs Boutons Panier
  document.getElementById('btn-submit-quick').addEventListener('click', async (e)=>{
    if(cart.length===0) return alert('Votre panier est vide.');
    
    // Vérification des champs de formulaire
    const form = document.getElementById('checkout-form');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const token = grecaptcha.getResponse();
    if(!token) return alert('Veuillez compléter le reCAPTCHA.');
    
    try {
        const payload = buildCreateOrderPayload('virement', null);
        const data = await postCreateOrder(payload);
        if(data.success){ showConfirmationAndClear(payload.prenom); } else { alert('Erreur création commande: ' + (data.error || data.message || 'Erreur')); console.error(data); }
    } catch(e){ 
        if(e.message !== "Missing shipping selection") console.error('createOrder err', e); 
        if(e.message !== "Missing shipping selection") alert('Erreur réseau / Panier vide.'); 
    }
  });
  
  // NOUVEAU : Bouton SumUp
  document.getElementById('sumup-btn').addEventListener('click', handleSumUpCheckout);

  document.getElementById('virement-button').addEventListener('click', ()=>{\r\n    document.getElementById('virement-info').classList.toggle('hidden');\r\n  });

  // Vider le panier (les deux boutons)
  document.getElementById('btn-clear-cart').addEventListener('click', ()=>{\r\n    if(confirm('Vider le panier ?')){ cart=[]; updateCartDisplays(); handlePaymentMethodChange(); }\r\n  });
  document.getElementById('btn-clear-cart-default').addEventListener('click', ()=>{\r\n    if(confirm('Vider le panier ?')){ cart=[]; updateCartDisplays(); handlePaymentMethodChange(); }\r\n  });
});

</script>
</body>
</html>
