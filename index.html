<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kicks - Boutique</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<!-- reCAPTCHA public key (client) -->
<script src="https://www.google.com/recaptcha/api.js?hl=fr" async defer></script>
<!-- PayPal SDK (client-id dÃ©jÃ  fourni; remplace si besoin) -->
<script src="https://www.paypal.com/sdk/js?client-id=AXd7iZon2xRzhIauBjGdjwxQk237evP3BTtNfqIKpEaYDTOk9S733o-_GcPQIqhZ7bCalMG-M_PNaRHG&currency=EUR" data-sdk-integration-source="button-factory"></script>

<style>
  :root{
    --orange:#FFA133;
    --anthracite:#1a1a1a;
    --white:#ffffff;
  }
  body{ background:#fff; color:#111; font-family:Inter,system-ui,Arial,Helvetica,sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  header{ background:var(--anthracite); color:var(--white); }
  .card{ background:var(--white); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  .btn{ transition:transform .12s ease, box-shadow .12s ease; }
  .btn:active{ transform:scale(.98); }
  .add-ok{ background: #16A34A !important; color: #fff !important; box-shadow: 0 6px 18px rgba(22,163,74,0.18); }
  .price-4x{ color: #0f172a; font-weight:600; font-size:0.95rem; display:block; margin-top:6px; }
  .product-image{ width:100%; height:260px; object-fit:contain; display:block; margin:auto; background:#fafafa; padding:8px; border-radius:8px; }
  .thumb{ width:48px; height:48px; object-fit:cover; border-radius:6px; border:1px solid #eee; cursor:pointer; margin-right:6px; }
  .thumb.active{ outline: 2px solid var(--orange); }
  .hidden{ display:none!important; }
  .grid-tiles{ display:grid; grid-template-columns: repeat(1,1fr); gap:1rem; }
  @media(min-width:768px){ .grid-tiles{ grid-template-columns: repeat(2,1fr); } }
  @media(min-width:1024px){ .grid-tiles{ grid-template-columns: repeat(3,1fr); } }
  .mini-scroll{ max-height:70vh; overflow:auto; }
  .popup-card{ border-radius:12px; }
</style>
</head>
<body>

<!-- HEADER -->
<header class="py-6 px-6">
  <div class="max-w-6xl mx-auto flex items-center justify-between">
    <div class="w-1/3"></div>
    <div class="w-1/3 text-center">
      <img id="site-logo" src="https://i.ibb.co/GvN8CbtQ/logo.png" alt="Kicks" style="height:64px; display:inline-block; object-fit:contain;">
    </div>
    <div class="w-1/3 text-right">
      <a href="https://gdt.kixx.fr" target="_blank" class="text-white underline">Guides des tailles</a>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-6">

  <!-- Top bar: recherche + total + 4x -->
  <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
    <div class="flex items-center gap-3 w-full md:w-2/3">
      <input id="search" type="search" placeholder="Rechercher produit, couleur, rÃ©fÃ©rence..." class="w-full p-3 border rounded">
      <select id="filter-size" class="p-3 border rounded">
        <option value="">Toutes tailles</option>
      </select>
    </div>
    <div class="w-full md:w-1/3 text-right">
      <div class="inline-block text-right">
        <div class="text-sm text-gray-500">Total panier</div>
        <div id="total-display" class="text-2xl font-bold">0.00 â‚¬</div>
        <div id="four-times-display" class="text-sm text-gray-600">â€”</div>
      </div>
    </div>
  </div>

  <!-- CATALOGUE : charge TOUS les produits (scroll vertical) -->
  <section id="catalogue" class="grid-tiles gap-6 mb-6"></section>

  <!-- PANIER + FORM -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- PANIER -->
    <aside class="card p-6">
      <h2 class="text-xl font-semibold mb-4">Votre panier</h2>
      <div id="panier-items" class="space-y-3 mini-scroll mb-4"></div>

      <div class="mt-4">
        <label for="delivery-select" class="block text-sm font-medium">Moyen de livraison</label>
        <select id="delivery-select" class="mt-1 p-2 border rounded w-full">
          <option value="">Choisir une zone d'abord</option>
        </select>
      </div>

      <div class="mt-4">
        <div class="flex justify-between items-center">
          <div class="text-sm">Sous-total</div>
          <div id="subtotal">0.00 â‚¬</div>
        </div>
        <div class="flex justify-between items-center mt-2">
          <div class="text-sm">Livraison</div>
          <div id="shipping-display">0.00 â‚¬</div>
        </div>
        <hr class="my-3">
        <div class="flex justify-between items-center">
          <div class="text-lg font-bold">Total</div>
          <div id="total-with-shipping" class="text-2xl font-bold">0.00 â‚¬</div>
        </div>
        <div class="text-sm text-gray-500 mt-1">Non assujetti Ã  la TVA</div>
      </div>

      <div class="mt-6 flex gap-3 items-center">
        <div id="paypal-button-container"></div>
        <button id="virement-toggle" class="btn px-4 py-2 rounded border" style="background:var(--anthracite); color:#fff">Payer par virement</button>
      </div>

      <div id="virement-info" class="mt-4 p-4 border rounded hidden">
        <h4 class="font-semibold mb-2">CoordonnÃ©es bancaires (RIB)</h4>
        <div><strong>Banque :</strong> SumUp Limited</div>
        <div><strong>IBAN :</strong> IE85SUMU99036512267268</div>
        <div><strong>Titulaire :</strong> R.Laskari / Kicks</div>
      </div>

    </aside>

    <!-- FORMULAIRE (s'affiche si panier non vide) -->
    <section id="order-section" class="card p-6 hidden">
      <h3 class="text-xl font-semibold mb-4">Validez votre commande</h3>
      <form id="order-form" class="space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input name="prenom" required placeholder="PrÃ©nom" class="p-2 border rounded" />
          <input name="nom" required placeholder="Nom" class="p-2 border rounded" />
        </div>
        <input name="telephone" required placeholder="TÃ©lÃ©phone" class="p-2 border rounded w-full" />
        <input name="email" type="email" required placeholder="Email" class="p-2 border rounded w-full" />
        <input name="adresse" required placeholder="Adresse complÃ¨te" class="p-2 border rounded w-full" />

        <!-- Zone + DOM postaux -->
        <div>
          <label class="text-sm">Zone de livraison</label>
          <select id="zoneLivraison" class="p-2 border rounded w-full">
            <option value="">-- Choisir la zone --</option>
            <option value="GUA">Guadeloupe</option>
            <option value="MAR">Martinique</option>
            <option value="GUY">Guyane</option>
            <option value="FR">France mÃ©tropolitaine</option>
            <option value="COR">Corse / Monaco / Andorre</option>
          </select>
        </div>

        <div id="dom-postal-container" class="hidden">
          <label class="text-sm">Commune / Code postal</label>
          <select id="dom-postal" class="p-2 border rounded w-full"></select>
        </div>

        <div id="city-container" class="hidden">
          <label class="text-sm">Commune</label>
          <input name="commune" placeholder="Commune" class="p-2 border rounded w-full" />
        </div>

        <div>
          <label class="text-sm">Mode de paiement</label>
          <select id="payment-method" name="modePaiement" required class="p-2 border rounded w-full">
            <option value="">-- Choisir --</option>
            <option value="paypal">PayPal</option>
            <option value="virement">Virement</option>
          </select>
        </div>

        <div class="mt-2">
          <div class="g-recaptcha" data-sitekey="6LcBZwosAAAAAG8xMR5po1FuipWeEo-_mJlROYFN"></div>
        </div>

        <div class="flex gap-3 mt-3">
          <button type="submit" class="btn px-4 py-2 rounded" style="background:var(--orange); color:#fff">Valider ma commande</button>
          <button type="button" id="simulate-onedit" class="px-4 py-2 border rounded">Forcer envoi PDF</button>
        </div>
      </form>
    </section>
  </div>

  <!-- Footer -->
  <footer class="mt-10 py-6 text-center" style="background:var(--anthracite); color:#fff;">
    <a href="https://shop.kixx.fr/page/conditions-generales" target="_blank" class="underline">Conditions gÃ©nÃ©rales</a>
    <div class="mt-2 text-sm">Â© 2025 Kicks</div>
  </footer>

</main>

<!-- POPUP remerciement -->
<div id="popup" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center">
  <div class="bg-white p-8 rounded-xl text-center max-w-md mx-4 popup-card">
    <h2 class="text-2xl font-bold mb-2">Merci pour votre commande&nbsp;<span id="popup-prenom"></span>&nbsp;!</h2>
    <p class="text-gray-600 mb-4">Vous allez Ãªtre redirigÃ© vers la page d'accueil.</p>
    <p>Fermeture automatique dans <span id="popup-count">10</span> secondes...</p>
  </div>
</div>

<script>
/* ===========================
   CONFIG â€” REMPLACE AVEC TON URL APPS SCRIPT /exec
   =========================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx1fmkYMGBmIdsTUo6mfMi8mD4yvLrbk9OWNJK2jlmYIEsXIliXfk8G14sPssWcRja2/exec"; // ðŸ”§ Colle ici l'URL WebApp (https://script.google.com/macros/s/XXX/exec)
const PAYPAL_MIN_FOR_4X = 30.00;
const RECAPTCHA_SITE_PUBLIC = "6Lf0wAMsAAAAAKgEth9Ses26qYpJN7Ennkb6S1Vq";

/* ===========================
   Listes DOM postaux (Guadeloupe, Martinique, Guyane)
   -> j'ai intÃ©grÃ© les communes/codes frÃ©quemment utilisÃ©s.
   Si tu veux la liste complÃ¨te exhaustive, je peux la complÃ©ter.
   =========================== */
const DOM_POSTAL = {
  GUA: [
    {code:"97110", commune:"Pointe-Ã -Pitre"},
    {code:"97111", commune:"Les Abymes"},
    {code:"97112", commune:"Gourbeyre"},
    {code:"97113", commune:"Baillif"},
    {code:"97115", commune:"Basse-Terre"},
    {code:"97118", commune:"Saint-FranÃ§ois"},
    {code:"97121", commune:"Anse-Bertrand"},
    {code:"97122", commune:"Baie-Mahault"},
    {code:"97123", commune:"Baie-Mahault (ZAC)"},
    {code:"97125", commune:"Bouillante"},
    {code:"97128", commune:"Sainte-Anne"},
    {code:"97129", commune:"Sainte-Rose"},
    {code:"97130", commune:"Capesterre-Belle-Eau"},
    {code:"97131", commune:"Deshaies"},
    {code:"97132", commune:"Le Gosier"},
    {code:"97133", commune:"Le Moule"},
    {code:"97134", commune:"Petit-Bourg"},
    {code:"97136", commune:"Les Abymes (2)"},
    {code:"97139", commune:"Les Abymes"} // etc.
  ],
  MAR: [
    {code:"97200", commune:"Fort-de-France"},
    {code:"97220", commune:"Le Lamentin"},
    {code:"97221", commune:"Le Carbet"},
    {code:"97223", commune:"Le Diamant"},
    {code:"97224", commune:"Le FranÃ§ois"},
    {code:"97232", commune:"Sainte-Anne"},
    {code:"97229", commune:"Sainte-Luce"},
    {code:"97233", commune:"Saint-Pierre"}
  ],
  GUY: [
    {code:"97300", commune:"Cayenne"},
    {code:"97310", commune:"Kourou"},
    {code:"97355", commune:"Macouria"},
    {code:"97351", commune:"Matoury"},
    {code:"97300", commune:"Cayenne (centre)"},
    {code:"97354", commune:"RÃ©mire-Montjoly"}
  ]
};

/* ===========================
   Express-served communes (depuis TARIF LIVRAISON)
   (communales express serviced in Guadeloupe)
   =========================== */
const EXPRESS_COMMUNES_GUA = ['Les Abymes','Le Gosier','Baie-Mahault','Morne-Ã -l\'Eau'];

/* ===========================
   STATE
   =========================== */
let productsAll = []; // produits chargÃ©s du Apps Script
let cart = []; // panier
let imageCache = {}; // track main image per product

/* ===========================
   UTIL
   =========================== */
function formatPrice(v){ return Number(v || 0).toFixed(2) + ' â‚¬'; }
function calcFourTimes(total){
  if(total >= PAYPAL_MIN_FOR_4X){
    return (total/4).toFixed(2);
  }
  return null;
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[c]); }

/* ===========================
   LOAD PRODUCTS (GET action=getProduits)
   =========================== */
async function loadProducts(){
  if(!SCRIPT_URL){ console.warn('SCRIPT_URL non configurÃ©.'); return; }
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getProduits`);
    const data = await res.json();
    if(!data.success){ console.error('Erreur getProduits', data); return; }
    productsAll = data.products || [];
    // Ensure images array exists and main image fallback
    productsAll.forEach(p=>{
      p.imageUrls = Array.isArray(p.imageUrls) ? p.imageUrls.slice(0,7) : [];
      if(p.imageUrl && p.imageUrl.trim()) {
        // put main image first if not already present
        if(!p.imageUrls.includes(p.imageUrl)) p.imageUrls.unshift(p.imageUrl);
      }
      if(!p.imageUrls || p.imageUrls.length===0) p.imageUrls = ['https://via.placeholder.com/420x300?text=No+image'];
      imageCache[p.modelBaseId] = p.imageUrls[0];
    });
    renderAllProducts();
    populateSizeFilter();
  } catch(err){ console.error('loadProducts error:', err); }
}

/* ===========================
   RENDER ALL PRODUCTS (single long page)
   =========================== */
function renderAllProducts(){
  const container = document.getElementById('catalogue');
  container.innerHTML = '';
  productsAll.forEach(prod=>{
    const el = document.createElement('article');
    el.className = 'card p-4';
    // build sizes options
    const sizesOpts = prod.sizes.map(s=>`<option value="${escapeHtml(s.fullId)}" data-price="${Number(s.price||0)}" data-size="${escapeHtml(s.size)}">${escapeHtml(s.size)} â€” ${Number(s.price||0).toFixed(2)} â‚¬</option>`).join('');
    const basePrice = prod.sizes && prod.sizes[0] ? prod.sizes[0].price : 0;
    // thumbnails
    const thumbsHtml = prod.imageUrls.map((u, idx) => `<img src="${u}" class="thumb ${idx===0?'active':''}" data-prod="${escapeHtml(prod.modelBaseId)}" data-src="${u}" alt="vue ${idx+1}">`).join('');
    const pay4Text = basePrice >= PAYPAL_MIN_FOR_4X ? `Payez en 4Ã— : ${(basePrice/4).toFixed(2)} â‚¬ / mois` : '';
    el.innerHTML = `
      <div class="text-center mb-3">
        <img id="main-${escapeHtml(prod.modelBaseId)}" class="product-image" src="${escapeHtml(imageCache[prod.modelBaseId])}" alt="${escapeHtml(prod.masterNameBase)}">
      </div>
      <div class="flex items-center justify-center mb-2">${thumbsHtml}</div>
      <h3 class="mt-3 font-semibold">${escapeHtml(prod.masterNameBase)}</h3>
      <p class="text-sm text-gray-600">${escapeHtml(prod.description||'')}</p>
      <div class="mt-2">
        <select id="size_${escapeHtml(prod.modelBaseId)}" class="p-2 border rounded w-full">${sizesOpts}</select>
      </div>
      <div class="mt-3 flex items-center justify-between">
        <div>
          <div class="text-lg font-bold">${formatPrice(basePrice)}</div>
          ${pay4Text ? `<div class="price-4x">${pay4Text}</div>` : ''}
        </div>
        <div>
          <button class="btn add-btn px-3 py-2 rounded border" data-model="${escapeHtml(prod.modelBaseId)}">+ Ajouter</button>
        </div>
      </div>
    `;
    container.appendChild(el);
  });

  // attach thumbnails click
  document.querySelectorAll('.thumb').forEach(t=>{
    t.addEventListener('click', function(){
      const prodId = this.dataset.prod;
      const src = this.dataset.src;
      // set main image
      const main = document.getElementById('main-' + prodId);
      if(main) main.src = src;
      // active classname
      document.querySelectorAll(`.thumb[data-prod="${prodId}"]`).forEach(x=>x.classList.remove('active'));
      this.classList.add('active');
    });
  });

  // attach add buttons
  document.querySelectorAll('.add-btn').forEach(b=>{
    b.addEventListener('click', function(){ 
      const model = this.dataset.model;
      addToCart(model);
      // quick green pulse
      this.classList.add('add-ok'); setTimeout(()=>this.classList.remove('add-ok'),700);
    });
  });

  // after render update totals
  updateTotalDisplays();
}

/* ===========================
   SIZE FILTER
   =========================== */
function populateSizeFilter(){
  const sizes = new Set();
  productsAll.forEach(p=> p.sizes.forEach(s=> sizes.add(s.size)));
  const sel = document.getElementById('filter-size');
  sel.innerHTML = '<option value="">Toutes tailles</option>';
  Array.from(sizes).sort().forEach(sz => sel.innerHTML += `<option value="${sz}">${sz}</option>`);
  sel.onchange = () => {
    const val = sel.value;
    // toggle visibility of product cards by size
    document.querySelectorAll('#catalogue article').forEach((card, idx)=>{
      const prod = productsAll[idx];
      if(!val) card.style.display = '';
      else {
        const has = prod.sizes.some(s=> s.size === val);
        card.style.display = has ? '' : 'none';
      }
    });
  };
}

/* ===========================
   ADD / RENDER CART
   =========================== */
function addToCart(modelBaseId){
  const sel = document.getElementById(`size_${modelBaseId}`);
  if(!sel) return alert('SÃ©lection introuvable');
  const opt = sel.options[sel.selectedIndex];
  const id = opt.value;
  const price = parseFloat(opt.dataset.price) || 0;
  const sizeLabel = opt.dataset.size || '';
  const title = (productsAll.find(p=>p.modelBaseId===modelBaseId)||{}).masterNameBase || modelBaseId;
  const existing = cart.find(c=>c.id===id);
  if(existing) existing.quantity++;
  else cart.push({ id, modelBaseId, price, quantity:1, sizeLabel, title});
  renderCart();
}

function renderCart(){
  const container = document.getElementById('panier-items');
  container.innerHTML = '';
  let subtotal = 0;
  cart.forEach(item=>{
    subtotal += item.price * item.quantity;
    const div = document.createElement('div');
    div.className = 'flex items-center justify-between';
    div.innerHTML = `
      <div>
        <div class="font-medium">${escapeHtml(item.title)}</div>
        <div class="text-sm text-gray-600">${escapeHtml(item.sizeLabel)} â€¢ ${item.quantity} Ã— ${Number(item.price).toFixed(2)} â‚¬</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="px-2 py-1 border rounded" onclick="changeQty('${item.id}', -1)">-</button>
        <div>${item.quantity}</div>
        <button class="px-2 py-1 border rounded" onclick="changeQty('${item.id}', 1)">+</button>
      </div>
    `;
    container.appendChild(div);
  });
  document.getElementById('subtotal').textContent = formatPrice(subtotal);
  // update delivery options (dependent on zone and subtotal)
  updateDeliveryOptions();
  // compute shipping
  const shipping = computeShipping();
  document.getElementById('shipping-display').textContent = formatPrice(shipping);
  const total = subtotal + shipping;
  document.getElementById('total-with-shipping').textContent = formatPrice(total);
  document.getElementById('total-display').textContent = formatPrice(total);
  const fourEach = calcFourTimes(total);
  document.getElementById('four-times-display').textContent = fourEach ? `ou 4Ã— ${fourEach} â‚¬` : 'â€”';
  document.getElementById('order-section').classList.toggle('hidden', cart.length===0);
  // re-render PayPal (label depends on 4x)
  renderPayPal();
}

/* change qty */
function changeQty(id, delta){
  const it = cart.find(c=>c.id===id);
  if(!it) return;
  it.quantity += delta;
  if(it.quantity<=0) cart = cart.filter(c=>c.id!==id);
  renderCart();
}

/* ===========================
   updateTotalDisplays (CORRECTION)
   =========================== */
function updateTotalDisplays(){
  // recalc totals, used after initial render or product filter
  let subtotal = cart.reduce((s,i)=>s + i.price*i.quantity, 0);
  document.getElementById('subtotal').textContent = formatPrice(subtotal);
  const shipping = computeShipping();
  document.getElementById('shipping-display').textContent = formatPrice(shipping);
  const total = subtotal + shipping;
  document.getElementById('total-with-shipping').textContent = formatPrice(total);
  document.getElementById('total-display').textContent = formatPrice(total);
  const fourEach = calcFourTimes(total);
  document.getElementById('four-times-display').textContent = fourEach ? `ou 4Ã— ${fourEach} â‚¬` : 'â€”';
}

/* ===========================
   DELIVERY: populate delivery methods based on zone & express communes
   computeShipping uses TARIF LIVRAISON rules
   =========================== */
function updateDeliveryOptions(){
  const zone = document.getElementById('zoneLivraison').value || '';
  const deliverySelect = document.getElementById('delivery-select');
  deliverySelect.innerHTML = '';
  if(!zone){
    deliverySelect.innerHTML = '<option value="">Choisir une zone d\'abord</option>';
    return;
  }
  // Common options
  if(zone === 'GUA' || zone === 'MAR' || zone === 'GUY'){
    // add Colissimo ss signature, Colissimo signature, Express (if commune eligible)
    deliverySelect.innerHTML += '<option value="colissimo_ns">Colissimo (sans signature)</option>';
    deliverySelect.innerHTML += '<option value="colissimo_s">Colissimo (avec signature)</option>';
    // express availability: depends on selected DOM postal commune
    const domSel = document.getElementById('dom-postal');
    const commune = domSel && !domSel.classList.contains('hidden') ? (domSel.options[domSel.selectedIndex] && domSel.options[domSel.selectedIndex].text.split(' â€” ')[1]) : '';
    if(zone==='GUA' && EXPRESS_COMMUNES_GUA.includes(commune)){
      deliverySelect.innerHTML += '<option value="express24">Express 24h</option>';
    }
  } else if(zone === 'FR'){
    deliverySelect.innerHTML += '<option value="colis_eco">Colissimo Ã©co (GUAâ†’FR)</option>';
    deliverySelect.innerHTML += '<option value="colis_std">Colissimo standard (GUAâ†’FR)</option>';
  } else if(zone === 'COR'){
    deliverySelect.innerHTML += '<option value="colis_std_cor">Colissimo standard (Corse/Monaco/Andorre)</option>';
  } else {
    deliverySelect.innerHTML += '<option value="standard">Standard</option>';
  }
  // select first option
  if(deliverySelect.options.length) deliverySelect.selectedIndex = 0;
}

/* compute shipping cost according to TARIF LIVRAISON rules */
function computeShipping(){
  const zone = document.getElementById('zoneLivraison').value || '';
  const subtotal = Number(document.getElementById('subtotal').textContent.replace(' â‚¬','')) || 0;
  const method = document.getElementById('delivery-select').value || '';
  // fallbacks replicating your TARIF LIVRAISON.txt
  if(zone === 'GUA' || zone === 'MAR' || zone === 'GUY'){
    if(method === 'colissimo_ns'){
      if(subtotal <= 75) return 12;
      if(subtotal <= 250) return 17;
      return 25;
    }
    if(method === 'colissimo_s'){
      if(subtotal <= 75) return 16;
      if(subtotal <= 250) return 25;
      return 30;
    }
    if(method === 'express24'){
      if(subtotal <= 80) return 10;
      return 20;
    }
  } else if(zone === 'FR'){
    if(method === 'colis_eco'){
      if(subtotal <= 75) return 20;
      if(subtotal <= 250) return 30;
      return 50;
    }
    if(method === 'colis_std'){
      if(subtotal <= 75) return 25;
      if(subtotal <= 250) return 34.70;
      return 64.70;
    }
  } else if(zone === 'COR'){
    if(subtotal <= 75) return 25;
    if(subtotal <= 250) return 34.70;
    return 64.70;
  }
  // fallback
  return 8.00;
}

/* ===========================
   Zone selection -> populate DOM postals if DOM selected
   =========================== */
document.getElementById('zoneLivraison').addEventListener('change', function(){
  const v = this.value;
  if(v === 'GUA' || v === 'MAR' || v === 'GUY'){
    const arr = DOM_POSTAL[v] || [];
    const sel = document.getElementById('dom-postal');
    sel.innerHTML = '';
    arr.forEach(it => sel.innerHTML += `<option value="${it.code}"> ${it.code} â€” ${it.commune} </option>`);
    document.getElementById('dom-postal-container').classList.remove('hidden');
    document.getElementById('city-container').classList.add('hidden');
  } else {
    document.getElementById('dom-postal-container').classList.add('hidden');
    document.getElementById('city-container').classList.remove('hidden');
  }
  updateDeliveryOptions();
  renderCart();
});

document.getElementById('dom-postal').addEventListener('change', function(){
  updateDeliveryOptions();
  renderCart();
});

document.getElementById('delivery-select').addEventListener('change', function(){ renderCart(); });

/* ===========================
   SUBMIT ORDER (createOrder)
   =========================== */
document.getElementById('order-form').addEventListener('submit', async function(e){
  e.preventDefault();
  if(!SCRIPT_URL) return alert('SCRIPT_URL non configurÃ© dans le front-end.');

  const form = e.target;
  const prenom = form.prenom.value.trim();
  const nom = form.nom.value.trim();
  const telephone = form.telephone.value.trim();
  const email = form.email.value.trim();
  const adresse = form.adresse.value.trim();
  const zone = document.getElementById('zoneLivraison').value || '';
  const communeCP = (zone==='GUA' || zone==='MAR' || zone==='GUY') ? document.getElementById('dom-postal').value : (form.commune ? form.commune.value : '');
  const methodePaiement = document.getElementById('payment-method').value || '';
  const deliveryMethod = document.getElementById('delivery-select').value || '';
  const subtotal = Number(document.getElementById('subtotal').textContent.replace(' â‚¬','')) || 0;
  const shipping = computeShipping();
  const totalFinal = subtotal + shipping;

  // reCAPTCHA client token
  const token = grecaptcha.getResponse();
  if(!token) return alert('Veuillez complÃ©ter le reCAPTCHA.');

  if(cart.length === 0) return alert('Votre panier est vide.');

  const productsJson = cart.map(c=> ({ id: c.id, quantity: c.quantity }));

  const payload = {
    action: 'createOrder',
    recaptchaResponse: token,
    productsJson: JSON.stringify(productsJson),
    totalFinal: totalFinal,
    methodePaiement: methodePaiement,
    modeLivraison: deliveryMethod,
    prenom: prenom,
    nom: nom,
    telephone: telephone,
    email: email,
    adresse: adresse,
    communeCP: communeCP,
    nombreArticlesTotal: cart.reduce((s,i)=>s+i.quantity,0),
    recapText: cart.map(c=> `${c.quantity}x ${c.title} ${c.sizeLabel} (${(c.price).toFixed(2)}â‚¬)` ).join(' | '),
    recapHTML: cart.map(c=> `<div>${c.quantity}x ${c.title} ${c.sizeLabel} â€” ${(c.price).toFixed(2)}â‚¬</div>` ).join('')
  };

  try {
    const res = await fetch(SCRIPT_URL, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.success){
      showPopupAndRedirect(prenom);
      cart = [];
      renderCart();
      form.reset();
      grecaptcha.reset();
    } else {
      alert('Erreur lors de la crÃ©ation de la commande : ' + (data.error || data.message || 'Erreur serveur'));
      console.error(data);
    }
  } catch(err){
    console.error('submit error', err);
    alert('Erreur rÃ©seau ou serveur (voir console).');
  }
});

/* ===========================
   PayPal integration (create order client-side, capture, then POST createOrder)
   - Handles referer/partitioning issues by capturing then calling createOrder server-side.
   =========================== */
function renderPayPal(){
  // clear container
  const container = document.getElementById('paypal-button-container');
  container.innerHTML = '';
  // compute totals
  const subtotal = cart.reduce((s,c)=>s + c.price*c.quantity, 0);
  const shipping = computeShipping();
  const total = (subtotal + shipping).toFixed(2);

  paypal.Buttons({
    style: { layout:'vertical', color:'gold', shape:'rect', label:'pay' },
    createOrder: function(data, actions){
      return actions.order.create({
        purchase_units: [{
          amount: { value: total }
        }]
      });
    },
    onApprove: function(data, actions){
      return actions.order.capture().then(function(details){
        // after capture, send createOrder to Apps Script with payment recorded
        const payerGiven = (details.payer && details.payer.name && details.payer.name.given_name) ? details.payer.name.given_name : '';
        const payerEmail = (details.payer && details.payer.email_address) ? details.payer.email_address : '';
        // prepare payload similar to form
        const payload = {
          action: 'createOrder',
          recaptchaResponse: grecaptcha.getResponse() || '',
          productsJson: JSON.stringify(cart.map(c=> ({ id:c.id, quantity:c.quantity }))),
          totalFinal: (Number(total)).toFixed(2),
          methodePaiement: 'paypal',
          modeLivraison: document.getElementById('delivery-select').value || '',
          prenom: payerGiven || (document.querySelector('[name=prenom]') ? document.querySelector('[name=prenom]').value : ''),
          nom: (document.querySelector('[name=nom]') ? document.querySelector('[name=nom]').value : ''),
          telephone: (document.querySelector('[name=telephone]') ? document.querySelector('[name=telephone]').value : ''),
          email: payerEmail || (document.querySelector('[name=email]') ? document.querySelector('[name=email]').value : ''),
          adresse: (document.querySelector('[name=adresse]') ? document.querySelector('[name=adresse]').value : ''),
          communeCP: (document.getElementById('dom-postal') && !document.getElementById('dom-postal').classList.contains('hidden')) ? document.getElementById('dom-postal').value : (document.querySelector('[name=commune]') ? document.querySelector('[name=commune]').value : ''),
          nombreArticlesTotal: cart.reduce((s,i)=>s+i.quantity,0),
          recapText: cart.map(c=> `${c.quantity}x ${c.title} ${c.sizeLabel} (${(c.price).toFixed(2)}â‚¬)` ).join(' | '),
          recapHTML: cart.map(c=> `<div>${c.quantity}x ${c.title} ${c.sizeLabel} â€” ${(c.price).toFixed(2)}â‚¬</div>` ).join('')
        };
        // POST to Apps Script to register order, deduct stock and send emails
        fetch(SCRIPT_URL, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
          .then(r=>r.json()).then(d=>{
            if(d.success){
              showPopupAndRedirect(payload.prenom || '');
              cart = []; renderCart();
            } else {
              alert('Erreur enregistrement commande aprÃ¨s paiement : ' + (d.error || d.message || 'Erreur'));
            }
          }).catch(err=>{
            console.error('Erreur POST createOrder aprÃ¨s PayPal', err);
            alert('Erreur rÃ©seau lors de l\'enregistrement aprÃ¨s paiement.');
          });
      });
    },
    onError: function(err){
      console.error('PayPal error', err);
      alert('Erreur PayPal. Voir console.');
    }
  }).render('#paypal-button-container');
}

/* ===========================
   Helper: show popup and redirect
   =========================== */
function showPopupAndRedirect(prenom){
  document.getElementById('popup-prenom').textContent = prenom || '';
  const pop = document.getElementById('popup');
  pop.classList.remove('hidden');
  let c = 10;
  document.getElementById('popup-count').textContent = c;
  const t = setInterval(()=>{
    c--; document.getElementById('popup-count').textContent = c;
    if(c<=0){ clearInterval(t); window.location.href = 'https://shop.kixx.fr'; }
  },1000);
}

/* ===========================
   Simulate onEdit button
   =========================== */
document.getElementById('simulate-onedit').addEventListener('click', async ()=>{
  const orderId = prompt('Entrez l\'ID de la commande Ã  forcer (ex: KICKS-XXXX):');
  if(!orderId) return;
  try{
    const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'simulateOnEdit', orderId: orderId, force: 'true' })});
    const json = await res.json();
    alert(JSON.stringify(json));
  } catch(e){ console.error(e); alert('Erreur simulateOnEdit'); }
});

/* ===========================
   Virement toggle
   =========================== */
document.getElementById('virement-toggle').addEventListener('click', function(){
  document.getElementById('virement-info').classList.toggle('hidden');
});

/* ===========================
   INIT
   =========================== */
window.addEventListener('load', async ()=>{
  await loadProducts();
  // re-render PayPal button (initially empty cart)
  renderPayPal();
  // Attach search filtering
  document.getElementById('search').addEventListener('input', function(){
    const q = this.value.trim().toLowerCase();
    document.querySelectorAll('#catalogue article').forEach((card, idx)=>{
      const prod = productsAll[idx];
      const matches = prod.masterNameBase.toLowerCase().includes(q) || (prod.description||'').toLowerCase().includes(q) || prod.modelBaseId.toLowerCase().includes(q);
      card.style.display = matches ? '' : 'none';
    });
  });
});
</script>
</body>
</html>
